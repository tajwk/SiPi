<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SiPi Telescope Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Modern Avalon-inspired stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <!-- SkyView styles (inline from skyview.html) -->
  <style>
    /* SkyView styles from skyview.html */
    html, body {
      margin:0; padding:0; overflow-x:hidden;
      background:black; color:white;
    }
    #skyviewContainer { display: none; position: relative; min-height: 100vh; background: black; color: white; }
    #skyviewTopBar {
      position:absolute; top:0; left:0; width:100vw;
      padding:10px; background:rgba(0,0,0,0.8);
      display:flex; gap:8px; align-items:center; z-index:20;
    }
    #skyviewTopBar input {
      width:6em; background:#222; color:#fff;
      border:1px solid #555; padding:2px 4px;
    }
    #skyviewTopBar button {
      background:#28a; color:#fff; border:none;
      padding:4px 8px; cursor:pointer;
    }
    #fullscreenBtn, #refreshBtn {
      position: absolute;
      top: 12px;
      z-index: 30;
      background: #28a;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
    }
    #fullscreenBtn { right: 12px; }
    #refreshBtn { right: 90px; }
    #starAttributes {
      position:absolute; top:60px; left:10px; z-index:20;
      background:rgba(0,0,0,0.7); padding:8px; border-radius:4px;
      font-size:0.9em; line-height:1.4;
    }
    #starAttributes > div {
      display: none;
    }
    #starAttributes > div.active {
      display: block;
    }
    #toggleMenuBtn {
      position: fixed;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      z-index: 31;
      background: #28a;
      color: white;
      border: none;
      padding: 8px 18px;
      border-radius: 8px 8px 0 0;
      font-size: 1.1em;
      cursor: pointer;
      margin-bottom: 0;
      transition: bottom 0.25s;
    }
    #toggleBar {
      position: fixed;
      left: 50%;
      bottom: 48px;
      transform: translateX(-50%);
      z-index: 30;
      background: rgba(0,0,0,0.92);
      padding: 14px 18px 14px 18px;
      border-radius: 12px 12px 0 0;
      display: flex;
      flex-wrap: wrap;
      gap: 18px 24px;
      font-size: 1em;
      align-items: flex-start;
      box-sizing: border-box;
      width: 98vw;
      max-width: 600px;
      transition: transform 0.25s, opacity 0.25s;
      opacity: 1;
      pointer-events: auto;
    }
    #toggleBar.hide {
      opacity: 0;
      pointer-events: none;
      transform: translateX(-50%) translateY(100%);
    }
    #toggleBar:not(.hide) ~ #toggleMenuBtn {
      bottom: calc(14px + 2.5em + 24px);
    }
    #toggleBar label {
      display: flex;
      align-items: flex-start;
      margin-bottom: 0;
      min-width: 120px;
    }
    #toggleBar input {
      vertical-align: middle;
      margin-top: 2px;
      margin-right: 6px;
    }
    @media (max-width: 600px) {
      #toggleBar {
        flex-direction: column;
        align-items: flex-start;
        width: 98vw;
        left: 1vw;
        transform: none;
        max-width: none;
      }
      #toggleBar label {
        min-width: unset;
        width: 100%;
      }
      #toggleMenuBtn {
        left: 1vw;
        transform: none;
      }
    }
    #skyviewCanvas {
      display: block;
      margin: 0 auto;
      position: relative;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      background: black;
      box-sizing: border-box;
      max-width: 100vw;
      max-height: 100vh;
    }
    #popup {
      position:absolute; background:rgba(0,0,0,0.8);
      color:white; padding:8px; border-radius:4px;
      font-family:sans-serif; display:none; z-index:40;
    }
    #popup button {
      margin-top:6px; padding:4px 8px;
      background:#28a; color:white; border:none;
      border-radius:3px; cursor:pointer;
    }
    #galFilterBar { display: none !important; visibility: hidden !important; height: 0 !important; width: 0 !important; overflow: hidden !important; position: absolute !important; }
  </style>

  <!-- Layout & style overrides -->
  <style>
    :root { --gap: 12px; --shadow: rgba(0,0,0,0.1); }

    /* Separator line */
    .separator {
      border: 0;
      border-top: 1px solid var(--shadow);
      margin: var(--gap) 0;
    }

    /* Center header buttons */
    .control-buttons {
      display: flex;
      justify-content: space-between;
      gap: var(--gap);
      margin: var(--gap) 0;
    }
    .control-buttons-left, .control-buttons-right {
      display: flex;
      gap: var(--gap);
      align-items: center;
    }

    /* Single spacer (~3em) */
    .spacer {
      height: 3em;
    }

    /* Center search form rows */
    .search-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--gap);
    }
    .search-form__row,
    .search-actions {
      display: flex;
      gap: var(--gap);
      justify-content: center;
    }

    /* Blank spacer after SkyView/Model */
    .small-spacer {
      height: var(--gap);
    }

    /* Center GoTo & Close buttons */
    #goToBtn,
    #closeResultsBtn {
      display: inline-block;
      margin: var(--gap) 0.5em var(--gap) 0.5em;
    }

    /* Status panel layout */
    .status-panel {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--gap);
    }
    .status-panel__left,
    .status-panel__right {
      display: flex;
      flex-direction: column;
    }
    .status-panel__right {
      text-align: right;
    }

    /* Center & style Model panel */
    .model-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .model-panel__info,
    .model-panel__actions {
      display: flex;
      gap: var(--gap);
      justify-content: center;
    }

    /* Style all buttons */
    .btn {
      background-color: var(--surface);
      color: var(--fg);
      border: 1px solid var(--accent);
      padding: 0.5em 1em;
      cursor: pointer;
    }

    /* Handpad: make controls 50% larger */
    .btn--control {
      width: calc(var(--control-size) * 1.5) !important;
      height: calc(var(--control-size) * 1.5) !important;
      font-size: 1.5rem;
    }

    /* Space before Start/Park row */
    .handpad__row--actions {
      display: flex;
      justify-content: center;
      gap: calc(var(--gap) * 2) !important;
      margin-top: var(--gap);
    }

    /* Handpad SVG, arcs, and center styling */
    .handpad {
      width: 300px;
      height: 300px;
      margin: var(--gap) auto;
    }
    .handpad svg {
      width: 100%;
      height: 100%;
    }
    .handpad-arc,
    .handpad-center {
      fill: var(--surface) !important;
      stroke: var(--accent) !important;
      stroke-width: 2;
      cursor: pointer;
      fill-opacity: 0.3;
    }
    .handpad-arc:hover,
    .handpad-center:hover {
      fill: var(--accent) !important;
      fill-opacity: 0.4;
    }

    /* Speed label styling (larger & bold) */
    .speed-label {
      font-size: 1.25rem;
      font-weight: bold;
      fill: var(--fg) !important;
      pointer-events: none;
    }

    /* Day/Night mode styles */
    body.night-mode {
      background: #111 !important;
      color: #f33 !important;
    }
    .status-panel {
      background: #f5f5f5;
      color: #111;
    }
    body.night-mode .status-panel {
      background: #222;
      color: #f33;
    }
    /* SkyView night mode overrides */
    #skyviewContainer {
      background: #000 !important;
      color: #f33 !important;
    }
    body.night-mode #skyviewContainer {
      background: #000 !important;
      color: #f33 !important;
    }
    #skyviewContainer label,
    #skyviewContainer span,
    #skyviewContainer div,
    #skyviewContainer input,
    #skyviewContainer button {
      color: inherit;
    }
    #skyviewContainer button {
      background: #222 !important;
      color: #f33 !important;
      border-radius: 8px !important;
      border: 1.5px solid #f33 !important;
      min-width: 38px;
      min-height: 38px;
      width: 38px;
      height: 38px;
      padding: 0;
      font-size: 1.2em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    #skyviewContainer button#toggleMenuBtn {
      width: auto;
      min-width: 90px;
      height: 38px;
      border-radius: 8px 8px 0 0 !important;
      margin-bottom: 0;
      padding: 0 18px;
      font-size: 1.1em;
    }
    #skyviewContainer input[type="text"] {
      background: #222 !important;
      color: #f33 !important;
      border: 1.5px solid #f33 !important;
      border-radius: 6px;
      padding: 2px 4px;
    }
    /* SkyView night mode checkboxes: red border, black center if off, red center if on */
    #skyviewContainer input[type="checkbox"] {
      width: 18px;
      height: 18px;
      border: 2px solid #f33 !important;
      background: #000 !important;
      border-radius: 4px;
      appearance: none;
      outline: none;
      cursor: pointer;
      position: relative;
      margin-right: 6px;
      vertical-align: middle;
      transition: background 0.15s, border 0.15s;
    }
    #skyviewContainer input[type="checkbox"]:checked {
      background: #f33 !important;
      border: 2px solid #f33 !important;
    }
    #skyviewContainer input[type="checkbox"]:checked::after {
      content: '';
      display: block;
      position: absolute;
      left: 4px;
      top: 1.5px;
      width: 6px;
      height: 10px;
      border: solid #000;
      border-width: 0 3px 3px 0;
      transform: rotate(45deg);
    }
    #skyviewContainer input[type="checkbox"]:not(:checked)::after {
      content: '';
      display: block;
      position: absolute;
      left: 4px;
      top: 1.5px;
      width: 6px;
      height: 10px;
      border: none;
    }
    #skyviewContainer label {
      color: #f33 !important;
    }
    #skyviewTopBar {
      background: rgba(0,0,0,0.85) !important;
    }
    #starAttributes {
      background: rgba(0,0,0,0.7) !important;
      color: #f33 !important;
    }
    #popup {
      background: rgba(0,0,0,0.8) !important;
      color: #f33 !important;
    }
    /* Ensure all buttons are square and rounded */
    #refreshBtn, #fullscreenBtn {
      border-radius: 8px !important;
      width: 38px;
      height: 38px;
      min-width: 38px;
      min-height: 38px;
      padding: 0;
      font-size: 1.2em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Search results styling */
    .search-results__info {
      background: #222;
      color: #f33;
      padding: 12px 18px;
      border-radius: 8px 8px 0 0;
      text-align: center;
      font-size: 1.08em;
      margin-top: 10px;
    }
    .search-results__actions {
      background: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 14px 0 18px 0;
      border-radius: 0 0 8px 8px;
      margin-bottom: 10px;
    }
    .search-results__actions--horizontal {
      flex-direction: row !important;
      justify-content: center;
      align-items: center;
      gap: 18px;
      padding: 14px 0 18px 0;
    }
    .search-results__actions .btn {
      min-width: 70px;
      min-height: 38px;
      height: 38px;
      font-size: 1.08em;
      border-radius: 6px;
      background: var(--surface, #222);
      color: var(--fg, #f33);
      border: 1.5px solid var(--accent, #f33);
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      text-align: center;
      padding: 0 16px;
    }
    .search-results__actions .btn:active {
      background: #333;
    }
    .search-results__none {
      background: #222;
      color: #f33;
      padding: 14px 18px;
      border-radius: 8px;
      text-align: center;
      margin-top: 10px;
    }
  </style>

  <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/skyview.js') }}" defer></script>
</head>
<body>
  <script>
    // Injected settings flags
    var vibrationEnabled = {{ vibration_enabled|tojson }};
    var tiltEnabled      = {{ tilt_enabled|tojson }};
    console.log("vibrationEnabled =", vibrationEnabled, "tiltEnabled =", tiltEnabled);
  </script>

  <div id="mainViewContainer">
    <div class="container">

      <!-- STATUS PANEL -->
      <div id="status" class="status-panel"></div>

      <hr class="separator">

      <!-- SEARCH + SKYVIEW / MODEL -->
      <div id="controlPanel" class="control-panel">
        <form id="searchForm" class="search-form" autocomplete="off">
          <!-- Search row -->
          <div class="search-form__row">
            <input type="text"
                   id="searchQuery"
                   class="search-form__input"
                   placeholder="Enter object nameâ€¦"
                   required
                   autocomplete="off">
            <button type="submit" class="btn btn--primary">Search</button>
          </div>
          <div id="results" class="search-results"></div>
          <!-- SkyView/Model row -->
          <div class="search-actions">
            <button type="button" id="skyviewButton" class="btn btn--secondary">SkyView</button>
            <button type="button" id="modelButton"   class="btn btn--secondary">Model</button>
          </div>
          <div class="small-spacer"></div>
        </form>

        <div id="modelPanel" class="model-panel hidden">
          <div class="model-panel__info">
            <span>Cal Pts: <strong id="modelCalPts">0</strong></span>
            <span>RMS:    <strong id="modelRMS">0</strong></span>
          </div>
          <div class="model-panel__actions">
            <button id="calptButton" class="btn">+ Cal Pt</button>
            <button id="clearButton" class="btn">Clear</button>
            <button id="saveButton"  class="btn">Save</button>
          </div>
        </div>
      </div>

      <hr class="separator">

      <!-- HANDPAD / MOVEMENT CONTROLS -->
      <div id="directionControl" class="handpad"></div>

      <!-- Single spacer -->
      <div class="spacer"></div>

      <!-- Config/Fullscreen/Day-Night -->
      <div class="control-buttons"></div>

      <!-- MODAL DIALOG -->
      <div id="customModal" class="modal hidden">
        <div class="modal__content"></div>
      </div>
    </div>
  </div>

  <!-- SKYVIEW CONTAINER (hidden by default) -->
  <div id="skyviewContainer" style="display:none;">
    <div id="skyviewTopBar">
      <label>Alt: <input id="gotoAlt" type="text" placeholder="DD:MM:SS"></label>
      <label>Az:  <input id="gotoAz"  type="text" placeholder="DD:MM:SS"></label>
      <button id="gotoCoordsBtn">GoTo</button>
    </div>
    <button id="refreshBtn" title="Back" aria-label="Back">&#8592;</button>
    <button id="fullscreenBtn" title="Fullscreen" aria-label="Fullscreen">&#x26F6;</button>
    <div id="starAttributes">
      <div id="nameInfo">Name: </div>
      <div id="hipInfo">HIP: </div>
      <div id="hdInfo">HD: </div>
      <div id="hrInfo">HR: </div>
      <div id="specInfo">Spectral Type: </div>
      <div id="colorInfo">Color Index: </div>
      <div id="distInfo">Distance: </div>
      <div id="magInfo">Magnitude: </div>
    </div>
    <button id="toggleMenuBtn">Objects &#x25BC;</button>
    <div id="toggleBar" class="hide">
      <label><input type="checkbox" id="toggleStars" checked> Stars</label>
      <label><input type="checkbox" id="toggleConst"> Constellations</label>
      <label style="margin-left:0.5em;"><input type="checkbox" id="toggleConstLabels" checked> Names</label>
      <label><input type="checkbox" id="toggleGal"> Galaxies</label>
      <label><input type="checkbox" id="toggleOpen"> Open Clusters</label>
      <label><input type="checkbox" id="toggleGlobular"> Globular Clusters</label>
      <label><input type="checkbox" id="toggleNebula"> Nebulae</label>
      <label><input type="checkbox" id="togglePlanetary"> Planetary Nebulae</label>
    </div>
    <canvas id="skyviewCanvas"
            data-latitude="{{ site_latitude }}"
            data-longitude="{{ site_longitude }}">
    </canvas>
    <div id="popup"></div>
  </div>

  <script>
  $(function(){
    // Insert header buttons
    $('.control-buttons').html(`
      <div class="control-buttons-left">
        <button class="btn btn--icon" id="editConfigBtn"    title="Settings">âš™</button>
        <button class="btn btn--icon" id="toggleFullScreen" title="Fullscreen">â›¶</button>
        <button class="btn btn--icon" id="toggleMode"        title="Day/Night">ðŸŒ™</button>
      </div>
      <div class="control-buttons-right">
        <button class="btn btn--icon" id="modeToggleButton"  title="Manual/Auto">A</button>
        <button class="btn btn--icon" id="parkToggleButton"  title="Park/Unpark">P</button>
      </div>
    `);

    // Modal helpers
    function showModal(html) {
      $('#customModal .modal__content').html(html);
      $('#customModal').removeClass('hidden');
    }
    function hideModal() {
      $('#customModal').addClass('hidden');
    }
    window.hideModal = hideModal;

    function customAlert(msg) {
      showModal(
        '<div class="modal__body">' + msg + '</div>' +
        '<div class="modal__footer">' +
          '<button class="btn" onclick="hideModal()">OK</button>' +
        '</div>'
      );
    }

    // Night-mode toggle
    function applyNight(){
      var on = localStorage.getItem('nightMode')==='enabled';
      $('body').toggleClass('night-mode', on);
      $('#toggleMode').text(on?'â˜€':'ðŸŒ™');
    }
    applyNight();
    window.addEventListener('storage', function(e){
      if(e.key==='nightMode') applyNight();
    });
    $('#toggleMode').click(function(){
      var on = !$('body').hasClass('night-mode');
      localStorage.setItem('nightMode', on?'enabled':'disabled');
      applyNight();
    });

    // Fullscreen & Settings
    $('#toggleFullScreen').click(function(){
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    });
    $('#editConfigBtn').click(function(){
      window.location.href = "{{ url_for('edit_config') }}";
    });

    // Update Status Panel
    function updateStatus() {
      $.getJSON('/status', function(d){
        function hmsToSec(hms) {
          var p = hms.split(':').map(Number);
          return p[0]*3600 + p[1]*60 + p[2];
        }
        function secToHms(s) {
          s = ((s % 86400) + 86400) % 86400;
          var h = Math.floor(s/3600),
              m = Math.floor((s%3600)/60),
              sec = Math.floor(s%60);
          return [h,m,sec].map(x => String(x).padStart(2,'0')).join(':');
        }
        var haSec = hmsToSec(d.sidereal) - hmsToSec(d.ra),
            haStr = secToHms(haSec);

        $('#status').html(
          '<div class="status-panel__left">'+
            '<div>RA: '+d.ra+' | DEC: '+d.dec+'</div>'+
            '<div>Alt: '+d.alt+' | Az: '+d.az+'</div>'+
            '<div>Status: '+d.tracking+'</div>'+
          '</div>'+
          '<div class="status-panel__right">'+
            '<div>Time: '+d.time+'</div>'+
            '<div>LST:  '+d.sidereal+'</div>'+
            '<div>HA:   '+haStr+'</div>'+
          '</div>'
        );

        $('#trackToggleButton').text(d.tracking==='Stopped'?'START':'STOP');
        // Remove old label updates for mode/park buttons
        // $('#parkToggleButton').text((d.tracking==='Parking'||d.tracking==='Parked')?'Unpark':'Park');
        // $('#modeToggleButton').text(d.tracking==='Blinky'?'Auto':'Manual');
      });
    }
    setInterval(updateStatus, 500);
    updateStatus();

    // Ensure only M/A and P/U are set
    function updateModeAndParkButtons() {
      $.getJSON('/status', function(d) {
        var isManual = d.tracking === 'Blinky';
        $('#modeToggleButton').text(isManual ? 'M' : 'A');
        var isParked = d.tracking === 'Parking' || d.tracking === 'Parked';
        $('#parkToggleButton').text(isParked ? 'U' : 'P');
      });
    }
    setInterval(updateModeAndParkButtons, 500);
    updateModeAndParkButtons();

    // Search handler
    $('#searchForm').submit(function(e){
      e.preventDefault();
      var q = $('#searchQuery').val().trim();
      if(!q) return customAlert("Enter an object name.");
      $.post('/search',{query:q}, function(data){
        window.searchResults = data.results;
        if(data.results.length>1){
          var html = '<div class="modal__body"><h3>Select result</h3>';
          data.results.forEach((it,i) => {
            html += '<button class="btn btn--full" onclick="selectSearchResult('+i+')">'+it.rawResult+'</button>';
          });
          html += '</div>';
          showModal(html);
        } else if(data.results.length===1){
          selectSearchResult(0);
        } else {
          $('#results').html('<div class="search-results__none">No results found.</div>');
        }
      }, 'json');
    });

    // Select & display a single result
    window.selectSearchResult = function(i) {
      var it = window.searchResults[i];
      window.currentRA  = it.raw_ra;
      window.currentDEC = it.raw_dec;
      $('#results').html(
        '<div class="search-results__info">'+
          'RA: '+it.ra+' | DEC: '+it.dec+
          (it.alt?' | Alt: '+it.alt:'')+
          (it.az?' | Az: '+it.az:'')+
          (it.info?' | '+it.info:'')+
        '</div>'+
        '<div class="search-results__actions search-results__actions--horizontal">'+
          '<button id="syncButton" class="btn">Sync</button>'+ 
          '<button id="goToBtn" class="btn btn--primary">GoTo</button>'+ 
          '<button id="closeResultsBtn" class="btn btn--secondary">X</button>'+ 
        '</div>'
      );
      $('#syncButton').off('click').on('click',function(){
        if(window.currentRA && window.currentDEC)
          $.post('/sync',{ra:window.currentRA,dec:window.currentDEC});
      });
      $('#goToBtn').off('click').on('click',function(){
        $.post('/goto',{ra:it.raw_ra,dec:it.raw_dec});
      });
      $('#closeResultsBtn').off('click').on('click',function(){
        $('#results').empty();
      });
      hideModal();
    };

    // SkyView toggle logic
    $('#skyviewButton').off('click').on('click', function() {
      $('#mainViewContainer').hide();
      $('#skyviewContainer').show();
      // Force SkyView JS to re-initialize if needed
      if (typeof window.dispatchEvent === 'function') {
        setTimeout(function() {
          window.dispatchEvent(new Event('resize'));
        }, 100);
      }
    });
    // Back arrow in SkyView (handled in skyview.js as well)
    $('#refreshBtn').off('click').on('click', function() {
      $('#skyviewContainer').hide();
      $('#mainViewContainer').show();
    });
    // SkyView menu toggle
    var toggleMenuBtn = document.getElementById('toggleMenuBtn');
    var toggleBar = document.getElementById('toggleBar');
    if(toggleMenuBtn && toggleBar) {
      toggleMenuBtn.addEventListener('click', function() {
        toggleBar.classList.toggle('hide');
        toggleMenuBtn.textContent = toggleBar.classList.contains('hide') ? 'Objects \u25b2' : 'Objects \u25bc';
      });
    }

    // Model panel controls
    $('#modelButton').click(function(){
      var panel = $('#modelPanel');
      panel.toggleClass('hidden');
      if(!panel.hasClass('hidden')) updateModelInfo();
    });
    function updateModelInfo(){
      $.post('/getModelInfo', function(d){
        $('#modelCalPts').text(d.cal_pts);
        $('#modelRMS').text(d.rms);
      }, 'json');
    }
    setInterval(()=>{ if(!$('#modelPanel').hasClass('hidden')) updateModelInfo(); },5000);

    $('#calptButton').click(()=>{ if(window.currentRA&&window.currentDEC) $.post('/calpt',{ra:window.currentRA,dec:window.currentDEC}); });
    // --- Clear Model button with confirmation ---
    $('#clearButton').click(function(){
      showModal(
        `<div class="modal__body">
          <strong>Clear Model?</strong>
          <div style="margin-top:10px;">This will erase all calibration points.<br>Are you sure?</div>
         </div>
         <div class="modal__footer">
          <button class="btn btn--primary" id="confirmClearBtn">Yes, Clear</button>
          <button class="btn" onclick="hideModal()">Cancel</button>
         </div>`
      );
      $('#confirmClearBtn').off('click').on('click', function() {
        $.post('/clear', function(resp){
          customAlert("Model cleared.");
          updateModelInfo && updateModelInfo();
        });
        hideModal();
      });
    });
    // --- End Clear Model logic ---
    $('#saveButton').click(()=>$.post('/save_model', ()=>customAlert("Model saved"), 'json'));

    // Movement controls
    function sendMove(axis,arg){ $.post('/moveaxis',{axis:axis,arg:arg}); }
    function startMove(axis,dir,btn){
      var code = window.currentSpeed==="Slew"
        ? ((dir==="down"||dir==="right")?"S":"s")
        : window.currentSpeed==="Pan"
          ? ((dir==="down"||dir==="right")?"P":"p")
          : ((dir==="down"||dir==="right")?"G":"g");
      sendMove(axis,code);
      if(vibrationEnabled) navigator.vibrate?.(150);
      var id = setInterval(()=>{
        sendMove(axis,code);
        if(vibrationEnabled) navigator.vibrate?.(150);
      },200);
      $(btn).data('intervalId',id);
    }
    function stopMove(axis,btn){
      var id = $(btn).data('intervalId');
      if(id) clearInterval(id);
      if(vibrationEnabled) navigator.vibrate?.(0);
      sendMove(axis,"");
    }
    var speeds=["Slew","Pan","Guide"];
    window.currentSpeedIndex=0;
    window.currentSpeed=speeds[0];

    // Render handpad SVG + action row
    $('#directionControl').html(`
      <svg class="handpad" viewBox="0 0 300 300">
        <path id="upButton"    class="handpad-arc" d="M 51 249 A 140 140 0 0 0 249 249 L 220.71 220.71 A 100 100 0 0 1 79.29 220.71 Z"/>
        <path id="rightButton" class="handpad-arc" d="M 249 249 A 140 140 0 0 0 249 51  L 220.71 79.29  A 100 100 0 0 1 220.71 220.71 Z"/>
        <path id="downButton"  class="handpad-arc" d="M 249 51  A 140 140 0 0 0 51 51   L 79.29 79.29   A 100 100 0 0 1 220.71 79.29 Z"/>
        <path id="leftButton"  class="handpad-arc" d="M 51 51   A 140 140 0 0 0 51 249  L 79.29 220.71 A 100 100 0 0 1 79.29 79.29 Z"/>
        <circle id="speedButton" class="handpad-center" cx="150" cy="150" r="60"/>
        <text x="150" y="150" text-anchor="middle" dominant-baseline="middle" class="speed-label">Slew</text>
      </svg>
      <div class="handpad__row handpad__row--actions">
        <button id="trackToggleButton" class="btn btn--primary">STOP</button>
      </div>
    `);

    // Bind directional arcs
    ['up','right','down','left'].forEach(dir=>{
      let axis = (dir==='up'||dir==='down')?"Sec":"Pri";
      $('#'+dir+'Button')
        .on('mousedown touchstart', e=>{ e.preventDefault(); startMove(axis,dir,e.currentTarget); })
        .on('mouseup touchend mouseleave', e=>{ stopMove(axis,e.currentTarget); });
    });

    // Speed toggle
    $('#speedButton').click(function(){
      window.currentSpeedIndex=(window.currentSpeedIndex+1)%speeds.length;
      window.currentSpeed=speeds[window.currentSpeedIndex];
      $('.speed-label').text(window.currentSpeed);
    });

    // Track/Park
    $('#trackToggleButton').click(function(){
      $.post($(this).text()==='STOP'?'/abort':'/start');
    });
    $('#parkToggleButton').click(function(){
      $.post($(this).text()==='P'?'/park':'/unpark');
    });

    // Auto/Manual
    $('#modeToggleButton').click(function(){
      $.post('/toggle_mode',{},function(){
        updateModeAndParkButtons();
      },'json');
    });

    // Dismiss modal if backdrop clicked
    $('#customModal').click(e=>{ if(e.target.id==='customModal') hideModal(); });

    // Remove focus outline after click
    $('button').click(function(){ this.blur(); });
  });
  </script>
</body>
</html>
