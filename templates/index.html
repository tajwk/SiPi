<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SiPi Telescope Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-touch-fullscreen" content="yes">

  <!-- Apply night mode immediately to prevent flash -->
  <script>
    if (localStorage.getItem('nightMode') === 'enabled') {
      document.documentElement.classList.add('night-mode');
    }
  </script>

  <!-- Modern Avalon-inspired stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <!-- SkyView styles (inline from skyview.html) -->
  <style>
    /* SkyView styles from skyview.html */
    html, body {
      margin:0; padding:0; overflow-x:hidden;
      background:black; color:white;
      /* Disable zoom and touch manipulation */
      touch-action: manipulation;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      /* Responsive scaling based on viewport */
      font-size: clamp(14px, 2.5vw, 18px);
    }
    
    /* Additional zoom prevention for touch devices */
    * {
      -webkit-text-size-adjust: 100%;
      -moz-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    
    /* Prevent zoom with CSS */
    html {
      -ms-touch-action: manipulation;
      touch-action: manipulation;
    }
    
    #skyviewContainer { display: none; position: relative; min-height: 100vh; background: black; color: white; }
    /* Coordinates display - centered horizontally above buttons */
    #skyviewTopBar {
      position:fixed; bottom:70px; left:50%; transform:translateX(-50%); width:auto;
      padding:10px; background:rgba(0,0,0,0.85);
      border:1px solid #555;
      border-radius:8px;
      display:flex; gap:8px; align-items:center; z-index:20;
    }
    
    /* Horizontal button row at bottom */
    #skyviewBottomButtons {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 25;
    }
    
    /* Uniform button styling - all buttons same size */
    .skyview-btn--uniform {
      width: 40px !important;
      height: 40px !important;
      min-width: 40px !important;
      min-height: 40px !important;
      max-width: 40px !important;
      max-height: 40px !important;
      padding: 0 !important;
      margin: 0 !important;
      border: 1px solid #555 !important;
      border-radius: 8px !important;
      background: #28a !important;
      color: white !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      box-sizing: border-box !important;
    }
    #skyviewTopBar input {
      width:6em; background:#222; color:#fff;
      border:1px solid #555; padding:2px 4px;
    }
    #skyviewTopBar button {
      background:#28a; color:#fff; border:none;
      padding:4px 8px; cursor:pointer;
    }
    #refreshBtn {
      position: absolute;
      top: 12px;
      right: 90px;
      z-index: 30;
      background: #28a;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
    }
    #starAttributes {
      position:absolute; top:10px; left:10px; z-index:25;
      background:rgba(0,0,0,0.7); padding:8px; border-radius:4px;
      font-size:0.9em; line-height:1.4;
      max-width: calc(80vw - 40px);
      width: auto;
    }
    #starAttributes > div {
      display: none;
    }
    #starAttributes > div.active {
      display: block;
    }
    
    /* Mobile: Make star info panel wider and prevent overlap */
    @media (max-width: 600px) {
      #starAttributes {
        max-width: calc(100vw - 20px) !important;
        width: auto;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    }
    
    /* Objects drawer - moved to upper right */
    #toggleMenuBtn {
      position: fixed !important;
      top: 10px !important;
      right: 10px !important;
      left: auto !important;
      width: auto !important;
      max-width: 120px !important;
      z-index: 31;
      background: #28a;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 1.0em;
      cursor: pointer;
      transition: all 0.25s;
    }
    #toggleBar {
      position: fixed;
      top: 60px;
      right: 10px;
      width: auto;
      max-width: 540px;
      z-index: 30;
      transform: none;
      background: rgba(0,0,0,0.92);
      padding: 14px 18px 14px 18px;
      border-radius: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 18px 24px;
      font-size: 1em;
      align-items: flex-start;
      box-sizing: border-box;
      transition: transform 0.25s, opacity 0.25s;
      opacity: 1;
      pointer-events: auto;
    }
    #toggleBar.hide {
      opacity: 0;
      pointer-events: none;
      transform: translateX(-50%) translateY(100%);
    }
    #toggleBar:not(.hide) ~ #toggleMenuBtn {
      bottom: calc(14px + 2.5em + 24px);
    }
    #toggleBar label {
      display: flex;
      align-items: flex-start;
      margin-bottom: 0;
      min-width: 120px;
    }
    #toggleBar input {
      vertical-align: middle;
      margin-top: 2px;
      margin-right: 6px;
    }
    @media (max-width: 600px) {
      #toggleBar {
        flex-direction: column;
        align-items: flex-start;
        width: auto;
        max-width: 405px;
        right: 5px;
        top: 50px;
      }
      #toggleBar label {
        min-width: unset;
        width: 100%;
      }
      #toggleMenuBtn {
        right: 5px !important;
        left: auto !important;
        top: 10px !important;
        transform: none;
      }
    }
    #skyviewCanvas {
      display: block;
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      /* Place above the button row (buttons are 40px high + 10px margin = 60px from bottom) */
      bottom: 60px;
      background: black;
      box-sizing: border-box;
      z-index: 10; /* Below controls (z-index:20) but above background */
      /* Maximize size: use all available width and height above buttons, but always a circle */
      width: min(calc(100vw - 12px), calc(100vh - 140px));
      height: min(calc(100vw - 12px), calc(100vh - 140px));
      min-width: 200px;
      min-height: 200px;
      aspect-ratio: 1 / 1;
      z-index: 10;
      border-radius: 50%;
      box-shadow: 0 4px 24px 0 rgba(0,0,0,0.7);
    }
    #popup {
      position:absolute; background:rgba(0,0,0,0.8);
      color:black; padding:8px; border-radius:4px;
      font-family:sans-serif; display:none; z-index:40;
    }
    body.night-mode #popup {
      color: #ff0000 !important;
    }
    #popup button {
      margin-top:6px; padding:4px 8px;
      background:#28a; color:white; border:none;
      border-radius:3px; cursor:pointer;
    }
    #galFilterBar { display: none !important; visibility: hidden !important; height: 0 !important; width: 0 !important; overflow: hidden !important; position: absolute !important; }
  </style>

  <!-- Layout & style overrides -->
  <style>
    :root { --gap: 12px; --shadow: rgba(0,0,0,0.1); }

    /* Separator line */
    .separator {
      border: 0;
      border-top: 1px solid var(--shadow);
      margin: var(--gap) 0;
    }

    /* Center header buttons */
    .control-buttons {
      display: flex;
      justify-content: space-between;
      gap: var(--gap);
      margin: var(--gap) 0;
    }
    .control-buttons--center {
      justify-content: center !important;
    }
    .control-buttons-left, .control-buttons-right {
      display: flex;
      gap: var(--gap);
      align-items: center;
    }

    /* Single spacer (~3em) */
    .spacer {
      height: 3em;
    }

    /* Center search form rows */
    .search-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--gap);
    }
    .search-form__row,
    .search-actions {
      display: flex;
      gap: var(--gap);
      justify-content: center;
    }

    /* Blank spacer after SkyView/Model */
    .small-spacer {
      height: var(--gap);
    }

    /* Center GoTo & Close buttons */
    #goToBtn,
    #closeResultsBtn {
      display: inline-block;
      margin: var(--gap) 0.5em var(--gap) 0.5em;
    }

    /* Status panel layout */
    .status-panel {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--gap);
    }
    .status-panel__left,
    .status-panel__right {
      display: flex;
      flex-direction: column;
    }
    .status-panel__right {
      text-align: right;
    }

    /* Center & style Model panel */
    .model-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .model-panel__info,
    .model-panel__actions {
      display: flex;
      gap: var(--gap);
      justify-content: center;
    }

    /* Style all buttons */
    .btn {
      background-color: var(--surface);
      color: var(--fg);
      border: 1px solid var(--accent);
      padding: 0.5em 1em;
      cursor: pointer;
    }

    /* Handpad: make controls 50% larger */
    .btn--control {
      width: calc(var(--control-size) * 1.5) !important;
      height: calc(var(--control-size) * 1.5) !important;
      font-size: 1.5rem;
    }

    /* Space before Start/Park row */
    .handpad__row--actions {
      display: flex;
      justify-content: center;
      gap: calc(var(--gap) * 2) !important;
      margin-top: var(--gap);
    }

    /* Handpad SVG, arcs, and center styling */
    .handpad {
      width: 300px;
      height: 300px;
      margin: var(--gap) auto;
    }
    .handpad svg {
      width: 100%;
      height: 100%;
    }
    .handpad-arc,
    .handpad-center {
      fill: var(--surface) !important;
      stroke: var(--accent) !important;
      stroke-width: 2;
      cursor: pointer;
      fill-opacity: 0.3;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    /* Remove hover effect for handpad arcs and center: only activate on press */
    /* .handpad-arc:hover, .handpad-center:hover { fill: var(--accent) !important; fill-opacity: 0.4; } */

    /* Speed label styling (larger & bold) */
    .speed-label {
      font-size: 1.25rem;
      font-weight: bold;
      fill: var(--fg) !important;
      pointer-events: none;
    }

    /* Day/Night mode styles */
    body.night-mode,
    html.night-mode body {
      background: #111 !important;
      color: #ff0000 !important;
    }
    .status-panel {
      background: #f5f5f5;
      color: #111;
    }
    body.night-mode .status-panel,
    html.night-mode .status-panel {
      background: #222;
      color: #ff0000;
    }
    /* SkyView night mode overrides */
    #skyviewContainer {
      background: #000 !important;
      color: #ff0000 !important;
    }
    body.night-mode #skyviewContainer,
    html.night-mode #skyviewContainer {
      background: #000 !important;
      color: #ff0000 !important;
    }
    #skyviewContainer label,
    #skyviewContainer span,
    #skyviewContainer div,
    #skyviewContainer input,
    #skyviewContainer button {
      color: inherit;
    }
    #skyviewContainer button {
      background: #222 !important;
      color: #ff0000 !important;
      border-radius: 8px !important;
      border: 1.5px solid #ff0000 !important;
      min-width: 38px;
      min-height: 38px;
      width: 38px;
      height: 38px;
      padding: 0;
      font-size: 1.2em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    #skyviewContainer button#toggleMenuBtn {
      width: auto !important;
      min-width: 90px !important;
      max-width: 200px !important;
      height: 38px;
      border-radius: 8px 8px 0 0 !important;
      margin-bottom: 0;
      padding: 0 18px;
      font-size: 1.1em;
    }
    #skyviewContainer input[type="text"] {
      background: #222 !important;
      color: #ff0000 !important;
      border: 1.5px solid #ff0000 !important;
      border-radius: 6px;
      padding: 2px 4px;
    }
    /* SkyView night mode checkboxes: red border, black center if off, red center if on */
    #skyviewContainer input[type="checkbox"] {
      width: 18px;
      height: 18px;
      border: 2px solid #ff0000 !important;
      background: #000 !important;
      border-radius: 4px;
      appearance: none;
      outline: none;
      cursor: pointer;
      position: relative;
      margin-right: 6px;
      vertical-align: middle;
      transition: background 0.15s, border 0.15s;
    }
    #skyviewContainer input[type="checkbox"]:checked {
      background: #ff0000 !important;
      border: 2px solid #ff0000 !important;
    }
    #skyviewContainer input[type="checkbox"]:checked::after {
      content: '';
      display: block;
      position: absolute;
      left: 4px;
      top: 1.5px;
      width: 6px;
      height: 10px;
      border: solid #000;
      border-width: 0 3px 3px 0;
      transform: rotate(45deg);
    }
    #skyviewContainer input[type="checkbox"]:not(:checked)::after {
      content: '';
      display: block;
      position: absolute;
      left: 4px;
      top: 1.5px;
      width: 6px;
      height: 10px;
      border: none;
    }
    #skyviewContainer label {
      color: #ff0000 !important;
    }
    #skyviewTopBar {
      background: transparent !important;
      border: 1px solid #ff0000 !important;
    }
    #starAttributes {
      background: rgba(0,0,0,0.7) !important;
      color: #ff0000 !important;
    }
    #popup {
      background: rgba(0,0,0,0.8) !important;
      color: #ff0000 !important;
    }
    /* Ensure all buttons are square and rounded */
    #refreshBtn {
      border-radius: 8px !important;
      width: 38px;
      height: 38px;
      min-width: 38px;
      min-height: 38px;
      padding: 0;
      font-size: 1.2em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Search results styling */
    .search-results__info {
      background: #f5f5f5;
      color: #333;
      padding: 12px 18px;
      border-radius: 8px 8px 0 0;
      text-align: center;
      font-size: 1.08em;
      margin-top: 10px;
    }
    body.night-mode .search-results__info,
    html.night-mode .search-results__info {
      background: #222;
      color: #ff0000;
    }
    .search-results__actions {
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 14px 0 18px 0;
      border-radius: 0 0 8px 8px;
      margin-bottom: 10px;
    }
    body.night-mode .search-results__actions,
    html.night-mode .search-results__actions {
      background: #222;
    }
    .search-results__actions--horizontal {
      flex-direction: row !important;
      justify-content: center;
      align-items: center;
      gap: 18px;
      padding: 14px 0 18px 0;
    }
    .search-results__actions .btn {
      background: #f5f5f5;
      color: #333;
      border: 1.5px solid #28a;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      text-align: center;
      padding: 0 16px;
    }
    .search-results__actions .btn:active {
      background: #e0eaff;
    }
    body.night-mode .search-results__actions .btn,
    html.night-mode .search-results__actions .btn {
      background: var(--surface, #222);
      color: #ff0000;
      border: 1.5px solid #ff0000;
    }
    body.night-mode .search-results__actions .btn:active,
    html.night-mode .search-results__actions .btn:active {
      background: #333;
    }
    .search-results__none {
      background: #f5f5f5;
      color: #333;
      padding: 14px 18px;
      border-radius: 8px;
      text-align: center;
      margin-top: 10px;
    }
    body.night-mode .search-results__none {
      background: #222;
      color: #ff0000;
    }
  </style>

  <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/skyview.js') }}?v={{ range(1000, 9999) | random }}" defer></script>
</head>
<body>
  <script type="text/javascript">
    // Injected settings flags
    var _vibrationEnabled = typeof vibration_enabled !== "undefined" ? vibration_enabled : false;
    var vibrationEnabled = typeof _vibrationEnabled !== "undefined" ? _vibrationEnabled : false;
    var _tiltEnabled = typeof tilt_enabled !== "undefined" ? tilt_enabled : false;
    var tiltEnabled = (typeof _tiltEnabled !== "undefined") ? _tiltEnabled : false;
    console.log("vibrationEnabled =", vibrationEnabled, "tiltEnabled =", tiltEnabled);
  </script>

  <div id="mainViewContainer">
    <div class="container">

      <!-- STATUS PANEL -->
      <div id="status" class="status-panel"></div>

      <hr class="separator">

      <!-- SEARCH + SKYVIEW / MODEL -->
      <div id="controlPanel" class="control-panel">
        <form id="searchForm" class="search-form" autocomplete="off">
          <!-- Search row -->
          <div class="search-form__row search-form__row--with-clear search-form__row--relative">
            <div class="search-input-wrapper">
              <input type="text"
                     id="searchQuery"
                     class="search-form__input"
                     placeholder="Enter object name…"
                     required
                     autocomplete="off">
              <button type="button" id="clearSearchBtn" aria-label="Clear search">&times;</button>
            </div>
            <button type="submit" class="btn btn--primary">Search</button>
          </div>
  <style>
    .search-form__row--relative { position: relative; }
    .search-input-wrapper {
      position: relative;
      display: flex;
      align-items: stretch;
      flex: 1 1 auto;
      width: 100%;
      height: 2.4em; /* Match input height */
    }
    .search-form__input {
      width: 18em;
      min-width: 120px;
      padding-right: 2.2em;
      box-sizing: border-box;
      height: 2.4em;
      line-height: 2.4em;
      font-size: 1em;
      /* Remove vertical-align if present */
    }
    #clearSearchBtn {
      display: none;
      position: absolute;
      right: 0.35em;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      font-size: 1.25em;
      color: #888;
      cursor: pointer;
      z-index: 2;
      padding: 0;
      line-height: 1;
      height: 1.6em;
      width: 1.6em;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #clearSearchBtn:active { color: #f33; }
    .search-form__row--with-clear .btn--primary {
      margin-left: 0.5em;
    }
    @media (max-width: 600px) {
      .search-form__input { width: 100%; min-width: 0; }
    }
  </style>
          <div id="results" class="search-results"></div>
          <!-- SkyView/Model row -->
          <div class="search-actions">
            <button type="button" id="skyviewButton" class="btn btn--secondary">SkyView</button>
            <button type="button" id="modelButton"   class="btn btn--secondary">Model</button>
          </div>
          <div class="small-spacer"></div>
        </form>

        <div id="modelPanel" class="model-panel hidden">
          <div class="model-panel__info">
            <span>Cal Pts: <strong id="modelCalPts">0</strong></span>
            <span>RMS:    <strong id="modelRMS">0</strong></span>
          </div>
          <div class="model-panel__actions">
            <button id="calptButton" class="btn">+ Cal Pt</button>
            <button id="delCalptButton" class="btn">- Cal Pt</button>
            <button id="clearButton" class="btn">Clear</button>
            <button id="saveButton"  class="btn">Save</button>
          </div>
        </div>
      </div>

      <hr class="separator">

      <!-- HANDPAD / MOVEMENT CONTROLS -->
      <div id="directionControl" class="handpad"></div>

      <!-- Control Tray for Mode/Park (right edge, handpad height) -->
      <div id="controlTrayBtn" title="Show/hide controls">&#x25C0;</div>
      <div id="controlTray" class="hide">
        <button id="controlTrayCollapse" title="Collapse tray" class="tray-collapse-btn">&#x25B6;</button>
        <button class="tray-btn" id="modeToggleButton">Manual</button>
        <button class="tray-btn" id="parkToggleButton">Park</button>
        <button class="tray-btn" id="editConfigBtn" title="Settings">⚙</button>
        <button class="tray-btn" id="toggleFullScreen" title="Fullscreen">⛶</button>
        <button class="tray-btn" id="toggleMode" title="Day/Night">🌙</button>
        <a class="tray-btn" id="helpBtn" title="Help" href="{{ url_for('quickstart') }}" target="_blank" rel="noopener">Help</a>
      </div>

      <!-- START and STOP BUTTONS below Handpad -->
      <div class="handpad-action-row">
        <button id="startButton" class="action-btn start-action-btn">START</button>
        <button id="trackToggleButton" title="Stop" aria-label="Stop" class="action-btn stop-octagon-btn stop-octagon-btn--xlarge">
          <svg class="stop-octagon-svg stop-octagon-svg--xlarge" width="75" height="75" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <polygon class="stop-octagon-shape" points="30.18,5 69.82,5 95,30.18 95,69.82 69.82,95 30.18,95 5,69.82 5,30.18"/>
            <text class="stop-octagon-text stop-octagon-text--xlarge" x="50" y="56" text-anchor="middle" font-size="30" font-family="'Arial Black', Arial, sans-serif" font-weight="900" letter-spacing="1.0" fill="#111" dominant-baseline="middle">STOP</text>
          </svg>
        </button>
      </div>

      <!-- Single spacer -->
      <div class="spacer"></div>

      <!-- Config/Fullscreen/Day-Night (removed, now in tray) -->

      <!-- MODAL DIALOG -->
      <div id="customModal" class="modal hidden">
        <div class="modal__content"></div>
      </div>
    </div>
  </div>

  <!-- SKYVIEW CONTAINER (hidden by default) -->
  <div id="skyviewContainer" style="display:none;">
    <!-- Coordinates display - bottom left above buttons -->
    <div id="skyviewTopBar">
      <div style="display: flex; flex-direction: column; gap: 3px;">
        <div style="display: flex; gap: 10px;">
          <label style="display: flex; align-items: center; min-width: 115px;">
            <span style="display: inline-block; width: 35px;">Alt:</span>
            <input id="gotoAlt" type="text" placeholder="DD:MM:SS" style="width: 75px;">
          </label>
          <label style="display: flex; align-items: center; min-width: 105px;">
            <span style="display: inline-block; width: 25px;">Az:</span>
            <input id="gotoAz" type="text" placeholder="DDD:MM:SS" style="width: 75px;">
          </label>
        </div>
        <div style="display: flex; gap: 10px;">
          <label style="display: flex; align-items: center; min-width: 115px;">
            <span style="display: inline-block; width: 35px;">Dec:</span>
            <input id="gotoDec" type="text" placeholder="DD:MM:SS" style="width: 75px;">
          </label>
          <label style="display: flex; align-items: center; min-width: 105px;">
            <span style="display: inline-block; width: 25px;">RA:</span>
            <input id="gotoRA" type="text" placeholder="HH:MM:SS" style="width: 75px;">
          </label>
        </div>
      </div>
    </div>
    
    <!-- Horizontal row of 8 buttons at bottom -->
    <div id="skyviewBottomButtons">
      <!-- Back button -->
      <button id="backBtn" aria-label="Back" class="skyview-btn skyview-btn--uniform">
        <span style="width:40px;height:40px;line-height:40px;display:inline-block;text-align:center;font-size:1.2em;">&#8592;</span>
      </button>
      
      <!-- Fullscreen button -->
      <button id="fullscreenBtn" aria-label="Fullscreen" class="skyview-btn skyview-btn--uniform">
        <span style="width:40px;height:40px;line-height:40px;display:inline-block;text-align:center;font-size:1.2em;">⛶</span>
      </button>
      
      <!-- Flip button -->
      <button id="flipBtn" aria-label="Flip E/W" class="skyview-btn skyview-btn--uniform">
        <span style="width:40px;height:40px;line-height:40px;display:inline-block;text-align:center;font-size:1.2em;">&#8596;</span>
      </button>
      
      <!-- Redraw button -->
      <button id="redrawBtn" aria-label="Redraw" class="skyview-btn skyview-btn--uniform">
        <span style="width:40px;height:40px;line-height:40px;display:inline-block;text-align:center;font-size:1.2em;">&#8635;</span>
      </button>
      
      <!-- Sync button (telrad reticle exactly matching skyview canvas) -->
      <button id="syncBtn" aria-label="Sync" class="skyview-btn skyview-btn--uniform">
        <svg width="40" height="40" viewBox="0 0 40 40">
          <g transform="translate(20,20) scale(0.75)" fill="none" stroke="currentColor" stroke-width="1.5">
            <!-- Inner complete circle (r=7) -->
            <circle cx="0" cy="0" r="7"/>
            
            <!-- Middle broken circle (r=12) - exact JavaScript arc angles -->
            <!-- NE: 7.5° to 82.5° -->
            <path d="M 11.946,1.567 A 12,12 0 0,1 1.567,11.946"/>
            <!-- SE: 97.5° to 172.5° -->
            <path d="M -1.567,11.946 A 12,12 0 0,1 -11.946,1.567"/>
            <!-- SW: 187.5° to 262.5° -->
            <path d="M -11.946,-1.567 A 12,12 0 0,1 -1.567,-11.946"/>
            <!-- NW: 277.5° to 352.5° -->
            <path d="M 1.567,-11.946 A 12,12 0 0,1 11.946,-1.567"/>
            
            <!-- Outer broken circle (r=17) - exact JavaScript arc angles -->
            <!-- NE: 7.5° to 82.5° -->
            <path d="M 16.929,2.220 A 17,17 0 0,1 2.220,16.929"/>
            <!-- SE: 97.5° to 172.5° -->
            <path d="M -2.220,16.929 A 17,17 0 0,1 -16.929,2.220"/>
            <!-- SW: 187.5° to 262.5° -->
            <path d="M -16.929,-2.220 A 17,17 0 0,1 -2.220,-16.929"/>
            <!-- NW: 277.5° to 352.5° -->
            <path d="M 2.220,-16.929 A 17,17 0 0,1 16.929,-2.220"/>
          </g>
        </svg>
      </button>
      
      <!-- Search button -->
      <button id="searchBtn" aria-label="Search Objects" class="skyview-btn skyview-btn--uniform">
        <span style="width:40px;height:40px;line-height:40px;display:inline-block;text-align:center;font-size:1.4em;">⌕</span>
      </button>
      
      <!-- Go button -->
      <button id="gotoCoordsBtn" aria-label="Go" class="skyview-btn skyview-btn--uniform">
        <span style="width:40px;height:40px;line-height:40px;display:inline-block;text-align:center;font-size:1.0em;font-weight:bold;">GO</span>
      </button>
      
      <!-- STOP button (rightmost) -->
      <button id="stopBtn" aria-label="Stop" class="skyview-btn skyview-btn--uniform">
        <svg class="stop-octagon-svg" width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
          <polygon class="stop-octagon-shape" points="12.07,2 27.93,2 38,12.07 38,27.93 27.93,38 12.07,38 2,27.93 2,12.07" style="stroke-width:1;"/>
          <text class="stop-octagon-text" x="20" y="21.5" text-anchor="middle" font-size="5" font-family="'Arial Black', Arial, sans-serif" font-weight="900" letter-spacing="0.5" fill="#111" dominant-baseline="middle">STOP</text>
        </svg>
      </button>
    </div>
  <style>
    .skyview-bottom-btns {
      position: absolute;
      bottom: 18px;
      right: 18px;
      z-index: 30;
    }
    .skyview-btn-vertical {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
    }
    .skyview-btn {
      background: #28a;
      color: #fff;
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      min-width: 40px;
      min-height: 40px;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0;
      box-sizing: border-box;
      transition: background 0.15s, color 0.15s;
      padding: 0;
      overflow: hidden;
    }
    .skyview-btn--stop {
      background: transparent;
      padding: 0;
    }
    .skyview-btn--icon {
      background: #28a;
    }
    .stop-octagon-svg {
      width: 40px;
      height: 40px;
      display: block;
    }
    @media (max-width: 600px) {
      .skyview-btn {
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
        font-size: 1em;
      }
      .skyview-bottom-btns {
        bottom: 56px; /* 1.5 * 32px button height, moves up for visibility */
        right: 8px;
      }
      .skyview-btn-vertical {
        gap: 8px;
      }
      .stop-octagon-svg {
        width: 32px;
        height: 32px;
      }
      .skyview-btn--icon span {
        width: 32px !important;
        height: 32px !important;
        line-height: 32px !important;
        font-size: 1em !important;
      }
    }
    
    /* Search and Sync Button Styles */
    .skyview-btn--search {
      background: #28a;
      color: #fff;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
    }
    
    .skyview-btn--search span {
      color: inherit;
      filter: none;
    }
    
    /* Night mode for search button icon */
    body.night-mode .skyview-btn--search,
    html.night-mode .skyview-btn--search {
      background: #661100;
      color: #ff0000;
    }
    
    body.night-mode .skyview-btn--search span,
    html.night-mode .skyview-btn--search span {
      color: #ff0000;
    }
    
    /* All skyview buttons now same size (40x40) - inherit container styling */
    #skyviewContainer #syncBtn,
    #skyviewContainer #gotoCoordsBtn {
      width: 40px !important;
      height: 40px !important;
      min-width: 40px !important;
      min-height: 40px !important;
      padding: 0 !important;
      cursor: pointer !important;
      box-sizing: border-box !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    /* Sync and Go button specific styles - let them inherit container colors */
    .skyview-btn--sync,
    .skyview-btn--go {
      width: 40px !important;
      height: 40px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    /* Night mode for sync and go button icons - inherit container background */
    body.night-mode .skyview-btn--sync span,
    body.night-mode .skyview-btn--go span,
    html.night-mode .skyview-btn--sync span,
    html.night-mode .skyview-btn--go span {
      color: #ff0000 !important;
    }
    
    /* Ensure TARGET text is always red */
    .skyview-btn--sync span {
      color: #ff0000 !important;
    }
    
    /* Search Popup Styles - Day Mode */
    #searchPopup {
      background: #1a1a1a !important;
      color: #ffffff !important;
      border: 2px solid #444 !important;
    }
    
    #searchPopup h3 {
      color: #ffffff !important;
    }
    
    #searchInput {
      background: #2a2a2a !important;
      color: #ffffff !important;
      border: 1px solid #666 !important;
      outline: none !important;
      box-shadow: none !important;
    }
    
    #searchInput:focus {
      background: #2a2a2a !important;
      color: #ffffff !important;
      border: 1px solid #888 !important;
      outline: none !important;
      box-shadow: none !important;
    }
    
    #searchInput::placeholder {
      color: #888 !important;
    }
    
    #searchExecuteBtn, #searchCancelBtn {
      background: #28a !important;
      color: #fff !important;
      border: none !important;
      border-radius: 4px !important;
      padding: 8px 16px !important;
      cursor: pointer !important;
    }
    
    /* Search Popup Night Mode Styles */
    body.night-mode #searchPopup,
    html.night-mode #searchPopup {
      background: #0a0a0a !important;
      color: #ff0000 !important;
      border: 2px solid #330000 !important;
    }
    
    body.night-mode #searchPopup h3,
    html.night-mode #searchPopup h3 {
      color: #ff0000 !important;
    }
    
    body.night-mode #searchInput,
    html.night-mode #searchInput {
      background: #1a0000 !important;
      color: #ff0000 !important;
      border: 1px solid #330000 !important;
      outline: none !important;
      box-shadow: none !important;
    }
    
    body.night-mode #searchInput:focus,
    html.night-mode #searchInput:focus {
      background: #1a0000 !important;
      color: #ff0000 !important;
      border: 1px solid #660000 !important;
      outline: none !important;
      box-shadow: none !important;
    }
    
    body.night-mode #searchInput::placeholder,
    html.night-mode #searchInput::placeholder {
      color: #660000 !important;
    }
    
    body.night-mode #searchExecuteBtn,
    body.night-mode #searchCancelBtn,
    html.night-mode #searchExecuteBtn,
    html.night-mode #searchCancelBtn {
      background: #661100 !important;
      color: #ff0000 !important;
    }
    
    body.night-mode #searchOverlay,
    html.night-mode #searchOverlay {
      background: rgba(0,0,0,0.8) !important;
    }
    
    /* Mobile responsiveness for new buttons */
    @media (max-width: 600px) {
      .skyview-btn--search {
        width: 32px;
        height: 32px;
      }
      #skyviewContainer #syncBtn, #skyviewContainer #gotoCoordsBtn {
        width: 32px !important;
        height: 32px !important;
        padding: 0 !important;
        font-size: 0.8em !important;
      }
      #searchPopup {
        min-width: 280px;
        padding: 15px;
      }
    }
    


    
    /* Remove duplicate STOP/Back/Redraw button rules to prevent hidden/extra buttons */
  </style>
    <div id="starAttributes">
      <div id="nameInfo">Name: </div>
      <div id="hipInfo">HIP: </div>
      <div id="hdInfo">HD: </div>
      <div id="hrInfo">HR: </div>
      <div id="specInfo">Spectral Type: </div>
      <div id="colorInfo">Color Index: </div>
      <div id="distInfo">Distance: </div>
      <div id="magInfo">Magnitude: </div>
    </div>
    <button id="toggleMenuBtn">Objects &#x25BC;</button>
    <div id="toggleBar" class="hide">
      <label><input type="checkbox" id="toggleStars" checked> <span style="color: white;">●</span> Stars <input type="range" id="starMagSlider" min="1" max="18" value="18" step="1" style="width: 120px; margin-left: 8px;"></label>
      <label style="margin-left:0.5em;"><input type="checkbox" id="toggleStarNames" checked> Names</label>
      <label><input type="checkbox" id="toggleConst"> <span style="color: #a259e6;">─</span> Constellations</label>
      <label style="margin-left:0.5em;"><input type="checkbox" id="toggleConstLabels" checked> Names</label>
      <label><input type="checkbox" id="toggleMessierNames" checked> Messier Names</label>
      <label><input type="checkbox" id="toggleGal"> <span style="color: rgb(255,100,150); font-size: 14px;">⬭</span> Galaxies <input type="range" id="galMagSlider" min="1" max="18" value="18" step="1" style="width: 120px; margin-left: 8px;"></label>
      <label><input type="checkbox" id="toggleOpen"> <span style="color: rgb(100,100,255);">○</span> Open Clusters</label>
      <label><input type="checkbox" id="toggleGlobular"> <span style="color: rgb(0,180,80);">⊕</span> Globular Clusters</label>
      <label><input type="checkbox" id="toggleNebula"> <span style="color: rgb(255,100,255);">□</span> Nebulae</label>
      <label><input type="checkbox" id="togglePlanetary"> <span style="color: rgb(127,255,0);">△</span> Planetary Nebulae</label>
      <label><input type="checkbox" id="toggleSolarSystem" checked> <span style="color: orange;">☉</span> Solar System</label>
      <label><input type="checkbox" id="toggleEcliptic"> <span style="color: #FFD700;">⸻</span> Ecliptic</label>
      <label><input type="checkbox" id="toggleCalPoints" checked> <span style="color: yellow;">⊕</span> Calibration Points</label>
      <label><input type="checkbox" id="toggleSkyViewNightMode"> <span>☾</span> True Night Mode</label>
    </div>
    <canvas id="skyviewCanvas"
            data-latitude="{{ site_latitude }}"
            data-longitude="{{ site_longitude }}">
    </canvas>
    <div id="popup"></div>
  </div>

  <!-- Search Popup -->
  <div id="searchPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: var(--bg-color, #1a1a1a); border: 2px solid var(--border-color, #444); border-radius: 8px; padding: 20px; min-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
    <h3 style="margin: 0 0 15px 0; color: var(--text-color, #ffffff); text-align: center;">Search Objects</h3>
    <div style="display: flex; flex-direction: column; gap: 10px;">
      <input id="searchInput" type="text" placeholder="Enter object name (e.g., M31, Vega, Polaris)" style="padding: 8px; border: 1px solid var(--border-color, #666); border-radius: 4px; background: var(--input-bg, #2a2a2a); color: var(--text-color, #ffffff); font-size: 14px;">
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="searchExecuteBtn" class="skyview-btn" style="flex: 1;">Search</button>
        <button id="searchCancelBtn" class="skyview-btn" style="flex: 1;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Search Popup Overlay -->
  <div id="searchOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;"></div>

  <script>
  $(function(){
    // Insert header buttons
    $('.control-buttons').html(`
      <div class="control-buttons-left">
        <button class="btn btn--icon" id="editConfigBtn"    title="Settings">⚙</button>
        <button class="btn btn--icon" id="toggleFullScreen" title="Fullscreen">⛶</button>
        <button class="btn btn--icon" id="toggleMode"        title="Day/Night">🌙</button>
      </div>
      <div class="control-buttons-right"></div>
    `);

    // Modal helpers
    function showModal(html) {
      $('#customModal .modal__content').html(html);
      $('#customModal').removeClass('hidden');
    }
    function hideModal() {
      $('#customModal').addClass('hidden');
    }
    window.hideModal = hideModal;

    function customAlert(msg) {
      showModal(
        '<div class="modal__body">' + msg + '</div>' +
        '<div class="modal__footer">' +
          '<button class="btn" onclick="hideModal()">OK</button>' +
        '</div>'
      );
    }

    // Night-mode toggle
    function applyNight(){
      var on = localStorage.getItem('nightMode')==='enabled';
      $('body').toggleClass('night-mode', on);
      $('html').toggleClass('night-mode', on);
      $('#toggleMode').text(on?'☀':'🌙');
      
      // Apply correct styling for current mode
      setTimeout(function() {
        forceTrayButtonNightMode();
      }, 100);
    }
    
    // Function to force night mode styling on tray buttons
    function forceTrayButtonNightMode() {
      // Wait a bit for the CSS to apply, then force the styles
      setTimeout(function() {
        $('.tray-btn, #controlTrayBtn, #controlTrayCollapse').each(function() {
          var $btn = $(this);
          if ($('body').hasClass('night-mode')) {
            $btn.css({
              'background': '#222',
              'color': '#ff0000', 
              'border': '1.5px solid #ff0000',
              'box-shadow': '0 2px 8px rgba(255,0,0,0.18)'
            });
          } else {
            // Remove night mode styling if not in night mode
            $btn.removeAttr('style');
          }
        });
      }, 50);
    }
    
    applyNight();
    window.addEventListener('storage', function(e){
      if(e.key==='nightMode') applyNight();
    });
    $('#toggleMode').click(function(){
      var on = !$('body').hasClass('night-mode');
      localStorage.setItem('nightMode', on?'enabled':'disabled');
      applyNight();
    });

    // Auto-blur buttons after click to remove persistent highlighting
    $('.tray-btn, #controlTrayBtn').on('click', function() {
      var $btn = $(this);
      setTimeout(function() {
        $btn.blur();
      }, 100);
    });

    // Set up MutationObserver to watch for style changes on tray buttons
    function setupTrayButtonWatcher() {
      if (typeof MutationObserver !== 'undefined') {
        var observer = new MutationObserver(function(mutations) {
          if ($('body').hasClass('night-mode')) {
            var needsForce = false;
            mutations.forEach(function(mutation) {
              if (mutation.type === 'attributes' && 
                  (mutation.attributeName === 'style' || mutation.attributeName === 'class')) {
                var target = $(mutation.target);
                if (target.hasClass('tray-btn') || target.attr('id') === 'controlTrayBtn' || target.attr('id') === 'controlTrayCollapse') {
                  needsForce = true;
                }
              }
            });
            if (needsForce) {
              forceTrayButtonNightMode();
            }
          }
        });
        
        // Watch for changes on tray buttons
        $('.tray-btn, #controlTrayBtn, #controlTrayCollapse').each(function() {
          observer.observe(this, { 
            attributes: true, 
            attributeFilter: ['style', 'class'] 
          });
        });
      }
    }
    
    // Initialize the watcher after a short delay
    setTimeout(setupTrayButtonWatcher, 100);
    
    // Less frequent enforcement to avoid conflicts
    setInterval(function() {
      forceTrayButtonNightMode(); // This now handles both night and day modes
    }, 5000); // Check every 5 seconds instead of 2
    
    // Also force on window events
    $(window).on('load resize orientationchange', function() {
      setTimeout(function() {
        forceTrayButtonNightMode(); // Handles both modes
      }, 100);
    });
    
    // Prevent zooming gestures
    document.addEventListener('gesturestart', function (e) {
      e.preventDefault();
    });
    document.addEventListener('gesturechange', function (e) {
      e.preventDefault();
    });
    document.addEventListener('gestureend', function (e) {
      e.preventDefault();
    });
    
    // Prevent double-tap zoom
    var lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      var now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    // Prevent desktop zoom with Ctrl+Wheel and keyboard shortcuts
    document.addEventListener('wheel', function(e) {
      if (e.ctrlKey) {
        e.preventDefault();
      }
    }, { passive: false });
    
    document.addEventListener('keydown', function(e) {
      // Prevent Ctrl+Plus, Ctrl+Minus, Ctrl+0 (zoom shortcuts)
      if (e.ctrlKey && (e.keyCode === 107 || e.keyCode === 109 || e.keyCode === 187 || e.keyCode === 189 || e.keyCode === 48)) {
        e.preventDefault();
      }
    });

    // Fullscreen & Settings
    $('#toggleFullScreen, #fullscreenBtn').click(function(){
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    });
    $('#editConfigBtn').click(function(){
      window.location.href = "{{ url_for('edit_config') }}";
    });

    // Update Status Panel
    function updateStatus() {
      $.getJSON('/status', function(d){
        function hmsToSec(hms) {
          var p = hms.split(':').map(Number);
          return p[0]*3600 + p[1]*60 + p[2];
        }
        function secToHms(s) {
          s = ((s % 86400) + 86400) % 86400;
          var h = Math.floor(s/3600),
              m = Math.floor((s%3600)/60),
              sec = Math.floor(s%60);
          return [h,m,sec].map(x => String(x).padStart(2,'0')).join(':');
        }
        
        // Function to format coordinates to 1 decimal place for seconds
        function formatCoordinate(coord) {
          if (!coord || typeof coord !== 'string') return coord;
          var parts = coord.split(':');
          if (parts.length === 3) {
            var seconds = parseFloat(parts[2]);
            if (!isNaN(seconds)) {
              parts[2] = seconds.toFixed(1);
            }
            return parts.join(':');
          }
          return coord;
        }
        
        // Function to format Alt/Az coordinates with whole minutes and whole seconds
        function formatAltAz(coord) {
          if (!coord || typeof coord !== 'string') return coord;
          var parts = coord.split(':');
          if (parts.length === 3) {
            var minutes = parseFloat(parts[1]);
            var seconds = parseFloat(parts[2]);
            if (!isNaN(minutes)) {
              parts[1] = Math.floor(minutes).toString().padStart(2, '0');
            }
            if (!isNaN(seconds)) {
              parts[2] = Math.floor(seconds).toString().padStart(2, '0');
            }
            return parts.join(':');
          }
          return coord;
        }
        
        // Function to format Alt specifically (DD:MM:SS format)
        function formatAlt(coord) {
          if (!coord || typeof coord !== 'string') return coord;
          var parts = coord.split(':');
          if (parts.length === 3) {
            // For Alt, ensure degrees is only 2 digits
            var degrees = parseInt(parts[0]);
            var minutes = parseFloat(parts[1]);
            var seconds = parseFloat(parts[2]);
            
            if (!isNaN(degrees)) {
              parts[0] = (degrees % 100).toString().padStart(2, '0'); // Keep only 2 digits for degrees
            }
            if (!isNaN(minutes)) {
              parts[1] = Math.floor(minutes).toString().padStart(2, '0');
            }
            if (!isNaN(seconds)) {
              parts[2] = Math.floor(seconds).toString().padStart(2, '0');
            }
            return parts.join(':');
          }
          return coord;
        }

        // Function to format Dec specifically (DD:MM:SS format, can be negative)
        function formatDec(coord) {
          if (!coord || typeof coord !== 'string') return coord;
          var isNegative = coord.startsWith('-');
          var cleanCoord = isNegative ? coord.substring(1) : coord;
          var parts = cleanCoord.split(':');
          if (parts.length === 3) {
            // For Dec, ensure degrees is only 2 digits
            var degrees = parseInt(parts[0]);
            var minutes = parseFloat(parts[1]);
            var seconds = parseFloat(parts[2]);
            
            if (!isNaN(degrees)) {
              parts[0] = (degrees % 100).toString().padStart(2, '0'); // Keep only 2 digits for degrees
            }
            if (!isNaN(minutes)) {
              parts[1] = Math.floor(minutes).toString().padStart(2, '0');
            }
            if (!isNaN(seconds)) {
              parts[2] = Math.floor(seconds).toString().padStart(2, '0');
            }
            return (isNegative ? '-' : '') + parts.join(':');
          }
          return coord;
        }
        
        var haSec = hmsToSec(d.sidereal) - hmsToSec(d.ra),
            haStr = secToHms(haSec);

        $('#status').html(
          '<div class="status-panel__left">'+
            '<div>Dec: '+formatCoordinate(d.dec)+' | RA: '+formatCoordinate(d.ra)+'</div>'+
            '<div>Alt: '+formatAlt(d.alt)+' | Az: '+formatAltAz(d.az)+'</div>'+
            '<div>Status: '+d.tracking+'</div>'+
          '</div>'+
          '<div class="status-panel__right">'+
            '<div>Time: '+d.time+'</div>'+
            '<div>LST:  '+d.sidereal+'</div>'+
            '<div>HA:   '+haStr+'</div>'+
          '</div>'
        );

        // $('#trackToggleButton').text('STOP'); // Removed to preserve SVG STOP button markup
        // Remove old label updates for mode/park buttons
        // $('#parkToggleButton').text((d.tracking==='Parking'||d.tracking==='Parked')?'Unpark':'Park');
        // $('#modeToggleButton').text(d.tracking==='Blinky'?'Auto':'Manual');
      });
    }
    setInterval(updateStatus, 500);
    updateStatus();

    // Update Mode and Park/Unpark button labels (full text)
    function updateModeAndParkButtons() {
      $.getJSON('/status', function(d) {
        var isManual = d.tracking === 'Blinky';
        // Swap labels: show 'Auto' when manual, 'Manual' when auto
        $('#modeToggleButton').text(isManual ? 'Auto' : 'Manual');
        var isParked = d.tracking === 'Parking' || d.tracking === 'Parked';
        $('#parkToggleButton').text(isParked ? 'Unpark' : 'Park');
      });
    }
    setInterval(updateModeAndParkButtons, 500);
    updateModeAndParkButtons();

    // Search handler
    $('#searchForm').submit(function(e){
      e.preventDefault();
      var q = $('#searchQuery').val().trim();
      if(!q) return customAlert("Enter an object name.");
      $.post('/search',{query:q}, function(data){
        window.searchResults = data.results;
        // Only show the selection popup if not just synced
        if (window.justSynced) {
          window.justSynced = false;
          if(data.results.length===1){
            selectSearchResult(0);
          } else if(data.results.length===0){
            $('#results').html('<div class="search-results__none">No results found.</div>');
          }
          return;
        }
        if(data.results.length>1){
          var html = '<div class="modal__body"><h3>Select result</h3>';
          data.results.forEach((it,i) => {
            // Extract Name, Magnitude, and Type from the info string
            var info = it.info || '';
            
            // Extract magnitude (Mag=X.X)
            var magMatch = info.match(/Mag=([0-9.-]+)/);
            var mag = magMatch ? magMatch[1] : 'N/A';
            
            // Extract type (Type=Something)
            var typeMatch = info.match(/Type=([^,]+)/);
            var type = typeMatch ? typeMatch[1] : 'Unknown';
            
            // Extract name (usually the last part after the last comma, or use a fallback)
            var name = 'Unknown';
            var parts = info.split(',');
            if (parts.length > 0) {
              // Try to find the name - it's often the last part or the first part
              var lastPart = parts[parts.length - 1].trim();
              var firstPart = parts[0].trim();
              
              // Use the last part if it doesn't contain '=' or special characters
              if (lastPart && !lastPart.includes('=') && !lastPart.includes('Size=')) {
                name = lastPart;
              } else if (firstPart && !firstPart.includes('=')) {
                name = firstPart;
              }
            }
            
            var buttonText = name + ' | Mag: ' + mag + ' | Type: ' + type;
            html += '<button class="btn btn--full" onclick="selectSearchResult('+i+')">'+buttonText+'</button>';
          });
          html += '</div>';
          showModal(html);
        } else if(data.results.length===1){
          selectSearchResult(0);
        } else {
          $('#results').html('<div class="search-results__none">No results found.</div>');
        }
      }, 'json');
    });

    // Select & display a single result
    window.selectSearchResult = function(i) {
      var it = window.searchResults[i];
      window.currentRA  = it.raw_ra;
      window.currentDEC = it.raw_dec;
      $('#results').html(
        '<div class="search-results__info">'+
          'RA: '+it.ra+' | DEC: '+it.dec+
          (it.alt?' | Alt: '+it.alt:'')+
          (it.az?' | Az: '+it.az:'')+
          (it.info?' | '+it.info:'')+
        '</div>'+
        '<div class="search-results__actions search-results__actions--horizontal">'+
          '<button id="syncButton" class="btn">Sync</button>'+ 
          '<button id="goToBtn" class="btn btn--primary">GoTo</button>'+ 
          '<button id="closeResultsBtn" class="btn btn--secondary">X</button>'+ 
        '</div>'
      );
      $('#syncButton').off('click').on('click',function(){
        if(window.currentRA && window.currentDEC) {
          window.justSynced = true;
          $.post('/sync',{ra:window.currentRA,dec:window.currentDEC});
        }
      });
      $('#goToBtn').off('click').on('click',function(){
        $.post('/goto',{ra:it.raw_ra,dec:window.currentDEC});
      });
      $('#closeResultsBtn').off('click').on('click',function(){
        $('#results').empty();
      });
      hideModal();
      // Clear searchResults after a selection to prevent popup reappearing
      setTimeout(function(){ window.searchResults = []; }, 0);
    };

    // SkyView toggle logic
    $('#skyviewButton').off('click').on('click', function(e) {
      console.log('[SkyView] Button clicked');
      
      const mainContainer = document.getElementById('mainViewContainer');
      const skyContainer = document.getElementById('skyviewContainer');
      
      // Hide main container
      if (mainContainer) {
        mainContainer.style.display = 'none';
      }
      
      // Show sky container  
      if (skyContainer) {
        skyContainer.style.display = 'block';
        skyContainer.style.visibility = 'visible';
      }
      
      // Double-check with jQuery too
      $('#mainViewContainer').hide();
      $('#skyviewContainer').show();
      
      console.log('[SkyView] Containers toggled successfully');
      
      // Force SkyView JS to re-initialize if needed
      if (typeof window.dispatchEvent === 'function') {
        setTimeout(function() {
          console.log('[SkyView] Dispatching resize event');
          window.dispatchEvent(new Event('resize'));
        }, 100);
      }
      
      // Prevent any default behavior
      e.preventDefault();
      e.stopPropagation();
      return false;
    });
    // SkyView Stop button
    $('#stopBtn').off('click').on('click', function() {
      $.post('/abort');
    });
    // Back arrow in SkyView (handled in skyview.js as well)
    $('#refreshBtn').off('click').on('click', function() {
      $('#skyviewContainer').hide();
      $('#mainViewContainer').show();
    });
    // SkyView menu toggle
    var toggleMenuBtn = document.getElementById('toggleMenuBtn');
    var toggleBar = document.getElementById('toggleBar');
    if(toggleMenuBtn && toggleBar) {
      toggleMenuBtn.addEventListener('click', function() {
        toggleBar.classList.toggle('hide');
        toggleMenuBtn.textContent = toggleBar.classList.contains('hide') ? 'Objects \u25b2' : 'Objects \u25bc';
      });
    }

    // Model panel controls
    $('#modelButton').click(function(){
      var panel = $('#modelPanel');
      panel.toggleClass('hidden');
      if(!panel.hasClass('hidden')) updateModelInfo();
    });
    function updateModelInfo(){
      $.post('/getModelInfo', function(d){
        $('#modelCalPts').text(d.cal_pts);
        $('#modelRMS').text(d.rms);
      }, 'json');
    }
    setInterval(()=>{ if(!$('#modelPanel').hasClass('hidden')) updateModelInfo(); },5000);

    $('#calptButton').click(()=>{ if(window.currentRA&&window.currentDEC) $.post('/calpt',{ra:window.currentRA,dec:window.currentDEC}); });
    $('#delCalptButton').off('click').on('click', function(){
      $.post('/RemoveLastCalPoint', function(resp){
        if (typeof updateModelInfo === 'function') updateModelInfo();
      });
    });
    // --- Clear Model button with confirmation ---
    $('#clearButton').click(function(){
      showModal(
        `<div class="modal__body">
          <strong>Clear Model?</strong>
          <div style="margin-top:10px;">This will erase all calibration points.<br>Are you sure?</div>
         </div>
         <div class="modal__footer">
          <button class="btn btn--primary" id="confirmClearBtn">Yes, Clear</button>
          <button class="btn" onclick="hideModal()">Cancel</button>
         </div>`
      );
      $('#confirmClearBtn').off('click').on('click', function() {
        $.post('/clear', function(resp){
          customAlert("Model cleared.");
          updateModelInfo && updateModelInfo();
        });
        hideModal();
      });
    });
    // --- End Clear Model logic ---
    $('#saveButton').click(()=>$.post('/save_model', ()=>customAlert("Model saved"), 'json'));

    // Movement controls
    function sendMove(axis,arg){ $.post('/moveaxis',{axis:axis,arg:arg}); }
    function startMove(axis,dir,btn){
      var code = window.currentSpeed==="Slew"
        ? ((dir==="up"||dir==="right")?"S":"s")
        : window.currentSpeed==="Pan"
          ? ((dir==="up"||dir==="right")?"P":"p")
          : ((dir==="up"||dir==="right")?"G":"g");
      sendMove(axis,code);
      if(vibrationEnabled) navigator.vibrate?.(150);
      var id = setInterval(()=>{
        sendMove(axis,code);
        if(vibrationEnabled) navigator.vibrate?.(150);
      },200);
      $(btn).data('intervalId',id);
    }
    function stopMove(axis,btn){
      var id = $(btn).data('intervalId');
      if(id) clearInterval(id);
      if(vibrationEnabled) navigator.vibrate?.(0);
      sendMove(axis,"");
    }
    var speeds=["Slew","Pan","Guide"];
    window.currentSpeedIndex=0;
    window.currentSpeed=speeds[0];

    // Render SVG handpad with 4 wide, spaced arcs at up/down/left/right (not corners)
    // Each arc is a quarter of a ring, centered on 0, 90, 180, 270 deg, with square gaps
    // --- Handpad geometry tweaks for more space and square gaps ---
    const arcOuterR = 182.5; // 50% wider arcs (was 150)
    const arcInnerR = 85; // restore original inner radius
    const arcGapDeg = 22; // larger gap for more square separation
    const arcSweep = 90 - arcGapDeg;
    const center = 200;
    function describeArc(cx, cy, r1, r2, startAngle, sweep) {
      // Returns SVG path for a ring sector (arc with thickness)
      const toRad = a => (a-90)*Math.PI/180.0;
      const endAngle = startAngle + sweep;
      const x1 = cx + r1 * Math.cos(toRad(startAngle));
      const y1 = cy + r1 * Math.sin(toRad(startAngle));
      const x2 = cx + r1 * Math.cos(toRad(endAngle));
      const y2 = cy + r1 * Math.sin(toRad(endAngle));
      const x3 = cx + r2 * Math.cos(toRad(endAngle));
      const y3 = cy + r2 * Math.sin(toRad(endAngle));
      const x4 = cx + r2 * Math.cos(toRad(startAngle));
      const y4 = cy + r2 * Math.sin(toRad(startAngle));
      const largeArc = sweep > 180 ? 1 : 0;
      return [
        "M", x1, y1,
        "A", r1, r1, 0, largeArc, 1, x2, y2,
        "L", x3, y3,
        "A", r2, r2, 0, largeArc, 0, x4, y4,
        "Z"
      ].join(" ");
    }
    const arcDefs = [
      {id:'upButton',    start: -arcSweep/2,        angle: 0},
      {id:'rightButton', start: 90-arcSweep/2,      angle: 90},
      {id:'downButton',  start: 180-arcSweep/2,     angle: 180},
      {id:'leftButton',  start: 270-arcSweep/2,     angle: 270}
    ];
    let arcPaths = arcDefs.map(a => `<path id="${a.id}" class="handpad-arc" d="${describeArc(center,center,arcOuterR,arcInnerR,a.start,arcSweep)}"/>`).join("\n");
    // --- Speed button: smaller, styled like arcs ---
    const speedBtnR = arcInnerR - 28; // smaller for more gap
    $('#directionControl').html(`
      <svg class="handpad" viewBox="0 0 400 400" width="340" height="340">
        ${arcPaths}
        <circle id="speedButton" class="handpad-center" cx="200" cy="200" r="${speedBtnR}"/>
        <text x="200" y="200" text-anchor="middle" dominant-baseline="central" class="speed-label">${window.currentSpeed}</text>
      </svg>
      <div class="handpad__row handpad__row--actions">
        <!-- Removed STOP button from here -->
      </div>
    `);
    // Update handpad SVG style injection for night mode red
    $("<style id='handpadArcStyle'>\n"
      // Day mode: blue border, gray background, black text
      + ".handpad-arc, .handpad-center {\n"
      + "  stroke: #28a !important;\n"
      + "  stroke-width: 2.5 !important;\n"
      + "  fill: #f5f5f5 !important;\n"
      + "  opacity: 1;\n"
      + "  cursor: pointer;\n"
      + "  transition: opacity 0.15s, fill 0.15s, stroke 0.15s;\n"
      + "}\n"
      + ".speed-label { font-size: 2.1em; font-weight: bold; fill: #111 !important; pointer-events: none; }\n"
      // Night mode: dark bg, #ff0000 border/text
      + "body.night-mode .handpad-arc, body.night-mode .handpad-center {\n"
      + "  stroke: #ff0000 !important;\n"
      + "  fill: #222 !important;\n"
      + "}\n"
      + "body.night-mode .speed-label { fill: #ff0000 !important; }\n"
      + "</style>").appendTo('head');
    // Remove any old handpadGridStyle
    $('style#handpadGridStyle').remove();
    // Bind directional arcs
    ['up','right','down','left'].forEach(dir=>{
      let axis = (dir==='up'||dir==='down')?"Sec":"Pri";
      // Remove any previous handlers to avoid duplicates
      $('#'+dir+'Button').off('pointerdown').on('pointerdown', function(e){
        e.preventDefault();
        startMove(axis,dir,this);
      });
      $('#'+dir+'Button').off('pointerup pointercancel pointerleave').on('pointerup pointercancel pointerleave', function(e){
        stopMove(axis,this);
      });
    });
    // Speed toggle
    $('#speedButton').click(function(){
      window.currentSpeedIndex=(window.currentSpeedIndex+1)%speeds.length;
      window.currentSpeed=speeds[window.currentSpeedIndex];
      $('.speed-label').text(window.currentSpeed);
    });

    // Dismiss modal if backdrop clicked
    $('#customModal').click(e=>{ if(e.target.id==='customModal') hideModal(); });


    // Remove focus outline after click
    $('button').click(function(){ this.blur(); });

    // --- Search clear button logic ---
    var $search = $('#searchQuery');
    var $clearBtn = $('#clearSearchBtn');
    function toggleClearBtn() {
      $clearBtn[$search.val().length > 0 ? 'show' : 'hide']();
    }
    $search.on('input', toggleClearBtn);
    $clearBtn.on('click', function() {
      $search.val('');
      $search.focus();
      toggleClearBtn();
      $('#results').empty();
    });
    toggleClearBtn();

    // --- Browser Choice and System Time Popup on First Boot ---
    // Fetch /status to get boot/session ID
    $.getJSON('/status', function(d) {
      var bootId = d.boot_id || d.bootid || d.session_id || d.sessionid || d.boot || null;
      if (!bootId) return; // backend must provide this
      var lastBootId = localStorage.getItem('lastBootId');
      if (lastBootId !== bootId) {
        // Enhanced captive portal detection
        var forceCaptiveDetection = false;
        var currentUrl = window.location.href;
        
        // Force captive portal if coming from specific URLs
        if (document.referrer.includes('generate_204') ||
            document.referrer.includes('connectivitycheck') ||
            document.referrer.includes('play.googleapis.com') ||
            document.referrer.includes('captive.apple.com') ||
            currentUrl.includes('?captive=1')) {
          forceCaptiveDetection = true;
          console.log('[Captive Portal] FORCED detection due to referrer/URL');
        }
        
        // Check for Android captive portal window titles
        if (navigator.userAgent.includes('Android')) {
          var androidCaptiveTitles = [
            'Sign in to Wi-Fi network',
            'Sign in to WiFi network', 
            'Sign in to network',
            'WiFi sign in',
            'Wi-Fi sign in',
            'Network sign in',
            'Internet may not be available'
          ];
          
          if (androidCaptiveTitles.some(title => document.title.includes(title))) {
            forceCaptiveDetection = true;
            console.log('[Captive Portal] FORCED detection due to Android title:', document.title);
          }
        }
        
        // Check if user is in captive portal mode before showing browser choice
        if (forceCaptiveDetection || isCaptivePortalMode()) {
          // Add URL parameter to help with detection on reload
          if (!currentUrl.includes('?captive=1') && !currentUrl.includes('&captive=1')) {
            var separator = currentUrl.includes('?') ? '&' : '?';
            var newUrl = currentUrl + separator + 'captive=1';
            window.history.replaceState({}, '', newUrl);
          }
          
          // First show browser choice popup, then system time popup
          showBrowserChoicePopup(function() {
            showSystemTimePopup(bootId);
          });
        } else {
          // Skip browser popup, go directly to system time popup
          showSystemTimePopup(bootId);
        }
      }
    });

    // Function to detect if user is in captive portal mode
    function isCaptivePortalMode() {
      // More reliable captive portal detection
      var userAgent = navigator.userAgent;
      var currentUrl = window.location.href;
      
      // DEFINITIVE indicators: Specific captive portal user agents
      var captivePortalUserAgents = [
        'CaptiveNetworkSupport',  // iOS captive portal
        'ConnectivityCheck',      // Android captive portal
        'NetworkUtility',         // Android captive portal
        'NCSI',                   // Windows Network Connectivity Status Indicator
        'Microsoft NCSI'          // Windows
      ];
      
      var hasCaptiveUserAgent = captivePortalUserAgents.some(indicator => 
        userAgent.includes(indicator)
      );
      
      // iOS specific detection (iOS captive portal is often just Mobile Safari with limited features)
      var isIOSCaptive = false;
      if (userAgent.includes('iPhone') || userAgent.includes('iPad')) {
        isIOSCaptive = (
          // iOS captive portal typically has these characteristics
          window.navigator.standalone === false &&                    // Not in standalone mode
          !window.DeviceMotionEvent &&                               // Restricted APIs
          (window.outerHeight === 0 || window.outerWidth === 0) ||   // Hidden window chrome
          document.title.toLowerCase().includes('wi-fi') ||          // iOS wifi title
          document.title.toLowerCase().includes('network') ||        // Network title
          window.location.hostname.includes('captive.apple.com') ||  // Apple captive portal
          window.location.hostname.includes('hotspot.apple.com') ||  // Apple hotspot
          // Additional iOS captive portal indicators
          (window.history.length <= 1 && window.location.href.includes('192.168.')) ||
          (window.screen && window.screen.width === 0) ||            // Screen not available
          !window.speechSynthesis ||                                 // Speech API restricted
          typeof window.orientation === 'undefined'                  // Orientation API restricted
        );
      }
      
      // Android specific detection (more aggressive for Android due to inconsistency)
      var isAndroidCaptive = false;
      if (userAgent.includes('Android')) {
        isAndroidCaptive = (
          // Android captive portal indicators - be more aggressive
          document.title.includes('Sign in to') ||                   // Standard Android captive title
          document.title.includes('WiFi') ||                         // WiFi in title (case sensitive)
          document.title.toLowerCase().includes('wifi') ||           // WiFi in title (lowercase)
          document.title.toLowerCase().includes('network') ||        // Network in title
          document.title.toLowerCase().includes('internet') ||       // Internet in title
          window.location.hostname.includes('connectivitycheck') ||  // Android connectivity check
          window.location.hostname.includes('play.googleapis.com') ||// Google Play connectivity
          window.location.hostname.includes('google.com') ||         // Google connectivity check
          // Check for Android captive portal window characteristics
          (window.outerHeight > 0 && window.innerHeight > 0 && 
           (window.outerHeight - window.innerHeight) > 120) ||       // Large browser chrome
          !window.chrome ||                                          // Chrome APIs not available
          window.navigator.connection === undefined ||               // Network API restricted
          // More aggressive Android detection
          (window.history.length <= 2 && window.location.href.includes('192.168.')) ||
          (window.screen && window.screen.availWidth !== window.screen.width) ||
          typeof window.webkitRequestFileSystem === 'undefined' ||   // File system API restricted
          typeof Android !== 'undefined'                            // Android WebView bridge
        );
      }
      
      // Check referrer for captive portal hints
      var hasCaptiveReferrer = (
        document.referrer.includes('captive') ||
        document.referrer.includes('portal') ||
        document.referrer.includes('connectivitycheck') ||
        document.referrer.includes('play.googleapis.com') ||
        document.referrer.includes('apple.com') ||
        document.referrer.includes('google.com/generate_204')
      );
      
      // If we have strong indicators, it's definitely captive
      if (hasCaptiveUserAgent || isIOSCaptive || isAndroidCaptive || hasCaptiveReferrer) {
        console.log('[Captive Portal Detection] CAPTIVE PORTAL DETECTED:', {
          hasCaptiveUserAgent: hasCaptiveUserAgent,
          isIOSCaptive: isIOSCaptive,
          isAndroidCaptive: isAndroidCaptive,
          hasCaptiveReferrer: hasCaptiveReferrer
        });
        return true;
      }
      
      // Check for regular browser features (if present, probably not captive)
      var isRegularBrowser = false;
      try {
        isRegularBrowser = (
          window.history && window.history.length > 2 &&           // Has browsing history (increased threshold)
          window.navigator.onLine !== undefined &&                 // Online status available
          window.outerHeight > 0 && window.outerWidth > 0 &&      // Normal window dimensions
          window.screen && window.screen.width > 0 &&             // Screen info available
          (!currentUrl.includes('192.168.') && 
           !currentUrl.includes('10.') && 
           !currentUrl.includes('172.')) &&                        // Not direct IP access
          (window.outerHeight - window.innerHeight) < 100 &&      // Normal browser chrome (tightened)
          window.localStorage &&                                   // Storage available
          window.sessionStorage &&                                // Session storage available
          typeof window.requestAnimationFrame !== 'undefined'     // Animation API available
        );
      } catch(e) {
        isRegularBrowser = false;
      }
      
      // If this is clearly a regular browser, don't show captive portal popup
      if (isRegularBrowser) {
        console.log('[Captive Portal Detection] REGULAR BROWSER detected - not captive portal');
        return false;
      }
      
      // Final fallback: Check for very limited features + direct IP access
      var hasVeryLimitedFeatures = false;
      try {
        hasVeryLimitedFeatures = (
          window.outerHeight === 0 ||                             // Hidden window chrome
          window.outerWidth === 0 ||
          window.parent !== window ||                             // Running in iframe
          !window.history ||                                      // No history object
          !window.localStorage ||                                 // No localStorage access
          window.history.length <= 1                             // Very limited history
        );
      } catch(e) {
        hasVeryLimitedFeatures = true;
      }
      
      var isDirectIPAccess = (
        currentUrl.includes('192.168.') || 
        currentUrl.includes('10.') || 
        currentUrl.includes('172.')
      );
      
      var isFallbackCaptive = hasVeryLimitedFeatures && isDirectIPAccess;
      
      // Comprehensive logging for debugging
      console.log('[Captive Portal Detection] FULL ANALYSIS:', {
        userAgent: userAgent,
        platform: navigator.platform,
        // Definitive indicators
        hasCaptiveUserAgent: hasCaptiveUserAgent,
        isIOSCaptive: isIOSCaptive,
        isAndroidCaptive: isAndroidCaptive,
        hasCaptiveReferrer: hasCaptiveReferrer,
        // Regular browser indicators
        isRegularBrowser: isRegularBrowser,
        // Fallback indicators
        hasVeryLimitedFeatures: hasVeryLimitedFeatures,
        isDirectIPAccess: isDirectIPAccess,
        isFallbackCaptive: isFallbackCaptive,
        // Context
        documentTitle: document.title,
        referrer: document.referrer,
        hostname: window.location.hostname,
        // Final decision
        finalDecision: isFallbackCaptive,
        windowFeatures: {
          outerHeight: window.outerHeight,
          innerHeight: window.innerHeight,
          outerWidth: window.outerWidth,
          innerWidth: window.innerWidth,
          historyLength: window.history ? window.history.length : 'undefined',
          onLine: window.navigator.onLine,
          standalone: window.navigator.standalone,
          hasChrome: !!window.chrome,
          hasDeviceMotion: !!window.DeviceMotionEvent,
          hasLocalStorage: !!window.localStorage,
          hasSessionStorage: !!window.sessionStorage,
          hasRequestAnimationFrame: typeof window.requestAnimationFrame !== 'undefined',
          hasWebkitFileSystem: typeof window.webkitRequestFileSystem !== 'undefined',
          screenWidth: window.screen ? window.screen.width : 'undefined',
          screenAvailWidth: window.screen ? window.screen.availWidth : 'undefined'
        }
      });
      
      // Return true only for captive portal scenarios
      return isFallbackCaptive;
    }

    // Function to show browser choice popup
    function showBrowserChoicePopup(callback) {
      var isNight = $('body').hasClass('night-mode');
      var currentUrl = window.location.href;
      var globeIcon = isNight ? '🔴' : '🌐'; // Red circle in night mode, blue globe in day mode
      var modalHtml = `
        <div class="modal__body${isNight ? ' night-mode' : ''}"
          style="${isNight ? 'color:#f33; background:#222; border-radius:8px; padding:15px;' : 'color:#111; background:#f5f5f5; border-radius:8px; padding:15px;'}">
          <strong>${globeIcon} Open in Your Browser?</strong>
          <div style="margin-top:15px; line-height:1.5;">
            For the best experience with full-screen support and all features, 
            would you like to open SiPi in your default browser?
          </div>
          <div style="margin-top:10px; font-size:0.9em; font-style:italic; opacity:0.8;">
            You're currently viewing this in a captive portal window which has limited functionality.
          </div>
        </div>
        <div class="modal__footer"
          style="${isNight ? 'background:#222; color:#f33; border-radius:0 0 8px 8px; padding:15px; text-align:center;' : 'background:#f5f5f5; color:#111; border-radius:0 0 8px 8px; padding:15px; text-align:center;'}">
          <button class="btn btn--primary" id="openInBrowserBtn" style="margin-right:10px;">${globeIcon} Open in Browser</button>
          <button class="btn" id="continueHereBtn">Continue Here</button>
        </div>
      `;
      showModal(modalHtml);
      
      $('#openInBrowserBtn').off('click').on('click', function() {
        // Better methods to escape captive portal and open in default browser
        var currentUrl = window.location.href;
        
        try {
          // Method 1: Android intent URL (most reliable for Android)
          if (navigator.userAgent.includes('Android')) {
            // Try multiple Android browser intents
            var intents = [
              // Chrome intent
              'intent://' + window.location.host + window.location.pathname + window.location.search + '#Intent;scheme=http;package=com.android.chrome;end',
              // Firefox intent
              'intent://' + window.location.host + window.location.pathname + window.location.search + '#Intent;scheme=http;package=org.mozilla.firefox;end',
              // Samsung Browser intent
              'intent://' + window.location.host + window.location.pathname + window.location.search + '#Intent;scheme=http;package=com.sec.android.app.sbrowser;end',
              // Generic browser intent
              'intent://' + window.location.host + window.location.pathname + window.location.search + '#Intent;scheme=http;action=android.intent.action.VIEW;end'
            ];
            
            // Try each intent with delays
            intents.forEach(function(intent, index) {
              setTimeout(function() {
                window.location.href = intent;
              }, index * 500);
            });
            
          } 
          // Method 2: iOS URL Schemes and Universal Links
          else if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
            // iOS captive portals are very restricted and can't open other apps
            // Provide clear manual instructions instead
            
            hideModal();
            
            var shortUrl = currentUrl.replace('http://', '').replace('https://', '');
            var instructions = `📱 iOS Instructions:\n\n` +
              `Since iOS captive portals are restricted, please follow these steps:\n\n` +
              `1️⃣ Close this captive portal window (tap "Cancel" or "Done")\n` +
              `2️⃣ Open Safari from your home screen\n` +
              `3️⃣ Type this address: ${shortUrl}\n` +
              `4️⃣ Bookmark it for easy access!\n\n` +
              `💡 The address is your WiFi router's IP address\n` +
              `📌 Remember: ${shortUrl}\n\n` +
              `🆘 Need more help? Go to: ${currentUrl.replace(/\/$/, '')}/ios-help`;
            
            // Try clipboard copy first (may work in some iOS versions)
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(currentUrl).then(function() {
                customAlert('✅ URL copied to clipboard!\n\n' + instructions);
              }).catch(function() {
                customAlert(instructions);
              });
            } else {
              customAlert(instructions);
            }
            
            if (callback) callback();
          }
          // Method 3: Desktop/other platforms
          else {
            // Try standard window.open with specific parameters
            var newWindow = window.open(currentUrl, '_blank', 'noopener,noreferrer,location=yes,toolbar=yes,menubar=yes');
            
            if (!newWindow) {
              // Fallback: Create download link that opens in browser
              var link = document.createElement('a');
              link.href = currentUrl;
              link.target = '_system';  // PhoneGap/Cordova system browser
              link.rel = 'external';    // Some mobile browsers recognize this
              link.download = '';       // Trigger download which may open browser
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            }
            
            hideModal();
            customAlert('Opening in your default browser...\n\nIf it doesn\'t open automatically, copy this URL:\n' + currentUrl);
            if (callback) callback();
          }
          
        } catch (e) {
          console.log('Could not open in browser:', e);
          hideModal();
          customAlert('Please manually open your browser and go to:\n' + currentUrl);
          if (callback) callback();
        }
      });
      
      $('#continueHereBtn').off('click').on('click', function() {
        hideModal();
        if (callback) callback();
      });
    }

    // Function to show system time popup
    function showSystemTimePopup(bootId) {
      var deviceTime = new Date();
      var timeStr = deviceTime.toLocaleString();
      var isNight = $('body').hasClass('night-mode');
      var modalHtml = `
        <div class="modal__body${isNight ? ' night-mode' : ''}"
          style="${isNight ? 'color:#f33; background:#222; border-radius:8px; padding:10px 0;' : 'color:#111; background:#f5f5f5; border-radius:8px; padding:10px 0;'}">
          <strong>Set System Time?</strong>
          <div style="margin-top:10px;">Would you like to set the Pi's system time to your device's current time?</div>
          <div style="margin-top:10px; font-size:1.1em;">Current device time: <span id="currentTimeDisplay" style="font-weight:bold;">${timeStr}</span></div>
          <div style="margin-top:5px; font-style:italic; font-size:0.9em;">(The exact time will be captured when you click "Set Time")</div>
        </div>
        <div class="modal__footer"
          style="${isNight ? 'background:#222; color:#f33; border-radius:0 0 8px 8px; padding:10px 0; text-align:center;' : 'background:#f5f5f5; color:#111; border-radius:0 0 8px 8px; padding:10px 0; text-align:center;'}">
          <button class="btn btn--primary" id="setSystemTimeBtn">Set Time</button>
          <button class="btn" id="dismissTimeBtn">Dismiss</button>
        </div>
      `;
      showModal(modalHtml);
      
      // Update the time display every second
      const updateTimeInterval = setInterval(function() {
        const now = new Date();
        $('#currentTimeDisplay').text(now.toLocaleString());
      }, 1000);
      
      // Make sure to clear the interval when the modal is closed
      const originalHideModal = window.hideModal;
      window.hideModal = function() {
        clearInterval(updateTimeInterval);
        originalHideModal();
        window.hideModal = originalHideModal;
      };
      
      $('#setSystemTimeBtn').off('click').on('click', function() {
        // Get the current time at the moment the button is clicked
        const currentTime = new Date();
        // Format the current time as local dt_str (YYYY-MM-DD HH:MM:SS)
        function pad(n) { return n.toString().padStart(2, '0'); }
        const dt_str = currentTime.getFullYear() + '-' + pad(currentTime.getMonth()+1) + '-' + pad(currentTime.getDate()) + ' ' + 
                       pad(currentTime.getHours()) + ':' + pad(currentTime.getMinutes()) + ':' + pad(currentTime.getSeconds());
        $.ajax({
          url: '/set_time',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ dt_str }),
          success: function() {
            customAlert('System time set!');
            localStorage.setItem('lastBootId', bootId);
          },
          error: function() {
            customAlert('Failed to set system time.');
          }
        });
        hideModal();
      });
      $('#dismissTimeBtn').off('click').on('click', function() {
        localStorage.setItem('lastBootId', bootId);
        hideModal();
      });
    }
  });
  </script>

  <script>
    // --- Track/Stop button logic ---
    $(document).on('click', '#trackToggleButton', function() {
      // Only stop
      $.post('/abort');
    });

    // --- Start button logic (tray) ---
    $(document).on('click', '#startButton', function() {
      $.post('/start');
    });

    // --- Manual/Auto and Park/Unpark button logic ---
    $(document).on('click', '#modeToggleButton', function() {
      $.post('/toggle_mode', function(d) {
        // Optionally update label immediately
        $('#modeToggleButton').text(d.mode === 'Manual' ? 'Manual' : 'Auto');
      }, 'json');
    });
    $(document).on('click', '#parkToggleButton', function() {
      var label = $(this).text().trim().toLowerCase();
      if(label === 'park') {
        $.post('/park');
      } else {
        $.post('/unpark');
      }
    });
  </script>

  <!-- Control Tray Styles -->
  <style>
    /* Control Tray Styles */
    #controlTrayBtn {
      position: fixed;
      top: 50%;
      right: 0;
      transform: translateY(-50%);
      background: #f5f5f5;
      color: #111;
      border-radius: 8px 0 0 8px;
      border: 1.5px solid #28a;
      padding: 0 8px;
      font-size: 2.1em;
      cursor: pointer;
      z-index: 9000;
      box-shadow: -2px 2px 8px rgba(0,0,0,0.18);
      width: 38px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: background 0.15s, color 0.15s, border 0.15s;
    }
    #controlTrayBtn:active, #controlTrayBtn:focus {
      background: #e0eaff;
      color: #111;
      border-color: #1a5a8a;
    }
    body.night-mode #controlTrayBtn,
    html.night-mode #controlTrayBtn {
      background: #222;
      color: #ff0000;
      box-shadow: -2px 2px 8px rgba(255,0,0,0.18);
      border: 1.5px solid #ff0000;
    }
    body.night-mode #controlTrayBtn:active, body.night-mode #controlTrayBtn:focus {
      background: #ff0000;
      color: #111;
      border-color: #ff0000;
    }
    #controlTray {
      position: fixed;
      top: calc(50% + 160px); /* Move drawer down by about four button heights (incremented again) */
      right: 0;
      transform: translateY(-50%);
      background: #f5f5f5;
      border-radius: 16px 0 0 16px;
      box-shadow: -2px 2px 16px rgba(0,0,0,0.22);
      padding: 16px 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
      z-index: 9001;
      min-width: 0;
      width: 120px;
      max-width: 140px;
      transition: right 0.25s, opacity 0.25s;
      border: 1.5px solid #28a;
    }
    #controlTray.hide {
      right: -140px;
      opacity: 0;
      pointer-events: none;
    }
    body.night-mode #controlTray {
      background: rgba(34,34,34,0.98);
      box-shadow: -2px 2px 16px rgba(255,0,0,0.22);
      border: 1.5px solid #ff0000;
    }
    .tray-btn {
      font-size: 1.08em;
      padding: 10px 0;
      border-radius: 8px;
      background: #f5f5f5;
      color: #111;
      border: 1.5px solid #28a;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      min-width: 90px;
      width: 100%;
      font-weight: bold;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border 0.15s;
      text-align: center;
    }
    .tray-btn:active {
      background: #e0eaff;
      color: #111;
      border-color: #1a5a8a;
    }
    .tray-collapse-btn {
      background: #f5f5f5 !important;
      color: #111 !important;
      border: 1.5px solid #28a !important;
      box-shadow: none !important;
      font-size: 2.1em !important;
      width: 38px !important;
      min-width: 38px !important;
      height: 38px !important;
      min-height: 38px !important;
      padding: 0 !important;
      align-self: center;
      margin-top: 10px;
      margin-bottom: 0;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px !important;
      transition: background 0.15s, color 0.15s, border 0.15s;
    }
    .tray-collapse-btn:active, .tray-collapse-btn:focus {
      background: #e0eaff !important;
      color: #111 !important;
      border-color: #1a5a8a !important;
    }
    body.night-mode .tray-collapse-btn {
      color: #ff0000 !important;
      background: transparent !important;
      border: 1.5px solid #ff0000 !important;
    }
    body.night-mode .tray-collapse-btn:active, body.night-mode .tray-collapse-btn:focus {
      color: #fff !important;
      background: #ff0000 !important;
      border: 1.5px solid #ff0000 !important;
    }
    .tray-btn:active, .tray-btn:focus {
      background: #1a5a8a;
      color: #eee;
    }
    /* Force red color for all tray buttons in night mode */
    body.night-mode .tray-btn,
    html.night-mode .tray-btn {
      background: #222 !important;
      color: #ff0000 !important;
      box-shadow: 0 2px 8px rgba(255,0,0,0.18) !important;
      border: 1.5px solid #ff0000 !important;
    }
    body.night-mode .tray-btn:active {
      background: #ff0000 !important;
      color: #111 !important;
      border: 1.5px solid #ff0000 !important;
    }
    body.night-mode .tray-btn:hover {
      background: #330000 !important;
      color: #ff0000 !important;
      border: 1.5px solid #ff0000 !important;
    }
    
    /* Specific ID overrides for extra specificity */
    body.night-mode #controlTrayBtn,
    body.night-mode button#editConfigBtn.tray-btn,
    body.night-mode button#toggleFullScreen.tray-btn,
    body.night-mode button#toggleMode.tray-btn,
    body.night-mode a#helpBtn.tray-btn {
      background: #222 !important;
      color: #ff0000 !important;
      border: 1.5px solid #ff0000 !important;
      box-shadow: 0 2px 8px rgba(255,0,0,0.18) !important;
    }
    
    /* Special styling for toggleMode button only */
    body.night-mode button#toggleMode.tray-btn {
      text-shadow: none !important;
    }
    
    body.night-mode #controlTrayBtn:active,
    body.night-mode button#editConfigBtn.tray-btn:active,
    body.night-mode button#toggleFullScreen.tray-btn:active,
    body.night-mode button#toggleMode.tray-btn:active,
    body.night-mode a#helpBtn.tray-btn:active {
      background: #ff0000 !important;
      color: #111 !important;
      border: 1.5px solid #ff0000 !important;
    }
    
    body.night-mode #controlTrayBtn:hover,
    body.night-mode button#editConfigBtn.tray-btn:hover,
    body.night-mode button#toggleFullScreen.tray-btn:hover,
    body.night-mode button#toggleMode.tray-btn:hover,
    body.night-mode a#helpBtn.tray-btn:hover {
      background: #330000 !important;
      color: #ff0000 !important;
      border: 1.5px solid #ff0000 !important;
    }
    @media (max-width: 700px) {
      #controlTray, #controlTrayBtn {
        top: calc(50% + 80px); /* Move drawer down even more on mobile too (double previous) */
        bottom: unset;
        left: unset;
        right: 0;
        transform: translateY(-50%);
        border-radius: 16px 0 0 16px;
        min-width: 0;
        width: 90px;
        max-width: 110px;
        flex-direction: column;
        align-items: flex-end;
        box-shadow: -2px 2px 16px rgba(0,0,0,0.22);
      }
      #controlTray.hide {
        right: -110px;
        bottom: unset;
        opacity: 0;
      }
      .tray-btn {
        min-width: 70px;
        font-size: 1em;
        padding: 8px 0;
      }
      #controlTrayBtn {
        right: 0;
        left: unset;
        top: 50%;
        bottom: unset;
        border-radius: 8px 0 0 8px;
        padding: 0 4px;
        font-size: 1.7em;
        width: 32px;
        height: 44px;
      }
    }

  /* STOP OCTAGON BUTTON (main page, now inline with Start) */
  .handpad-action-row {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 8em !important; /* Increased gap to prevent overlap */
    margin: 0.2em 0 0 0 !important; /* Move row as high as possible, just below handpad */
    flex-wrap: wrap; /* Allow wrapping on very small screens */
    min-height: 110px; /* Ensure minimum height to prevent cramping */
  }
  .action-btn {
    background: #f5f5f5;
    border: 2.5px solid #28a;
    border-radius: 8px;
    width: 100px !important;
    height: 100px !important;
    min-width: 100px !important;
    min-height: 100px !important;
    max-width: 100px !important;
    max-height: 100px !important;
    font-size: 2em;
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.15s, border 0.15s, box-shadow 0.15s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    position: relative;
    z-index: 2101;
    margin: 0;
    padding: 0;
    box-sizing: border-box !important;
  }
  .start-action-btn {
    font-weight: bold;
    background: #f5f5f5;
    color: #111;
    border: 2.5px solid #28a;
    /* Force exact same dimensions as base action-btn - 75% size */
    width: 75px !important;
    height: 75px !important;
    min-width: 75px !important;
    min-height: 75px !important;
    max-width: 75px !important;
    max-height: 75px !important;
    box-sizing: border-box !important;
    font-size: 0.75em;
  }
  .start-action-btn:active, .start-action-btn:focus {
    background: #e0eaff;
    color: #111;
    border-color: #1a5a8a;
  }
  body.night-mode .start-action-btn,
  html.night-mode .start-action-btn {
    background: #222;
    color: #ff0000;
    border: 2.5px solid #ff0000;
  }
  body.night-mode .start-action-btn:active, body.night-mode .start-action-btn:focus {
    background: #ff0000;
    color: #fff;
    border-color: #ff0000;
  }
  .action-btn:active, .action-btn:focus {
    background: #e0eaff;
    outline: none;
    border-color: #1a5a8a;
  }
  .stop-octagon-btn {
    background: transparent;
    border: 2.5px solid #28a;
    box-shadow: none;
    width: 75px !important;
    height: 75px !important;
    min-width: 75px !important;
    min-height: 75px !important;
    max-width: 75px !important;
    max-height: 75px !important;
    padding: 0;
    font-size: 2.7em;
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    z-index: 2101;
    margin: 0;
    box-sizing: border-box !important;
  }
  .stop-octagon-btn:active, .stop-octagon-btn:focus {
    background: transparent;
    outline: none;
    border: 2.5px solid #1a5a8a;
  }
  .stop-octagon-svg {
    width: 70px !important;
    height: 70px !important;
    display: block;
  }
  .stop-octagon-shape {
    fill: #a11;
    stroke: none;
  }
  .stop-octagon-text {
    font-family: 'Arial Black', Arial, sans-serif;
    font-size: 0.54em;
    font-weight: 900;
    letter-spacing: 0.04em;
    fill: #fff;
    dominant-baseline: middle;
    pointer-events: none;
    user-select: none;
  }
  /* Extra large STOP button variant for main page */
  .stop-octagon-btn--xlarge {
    width: 75px;
    height: 75px;
    min-width: 75px;
    min-height: 75px;
  }
  .stop-octagon-svg--xlarge {
    width: 75px;
    height: 75px;
  }
  .stop-octagon-text--xlarge {
    font-size: 40px;
    letter-spacing: 1.2px;
    font-family: 'Arial Black', Arial, sans-serif;
    font-weight: 900;
    fill: #fff;
    dominant-baseline: middle;
    pointer-events: none;
    user-select: none;
  }
  body.night-mode .stop-octagon-btn {
    background: #222;
    border: 2.5px solid #ff0000;
    box-shadow: 0 2px 8px rgba(255,0,0,0.18);
  }
  body.night-mode .stop-octagon-btn:active, body.night-mode .stop-octagon-btn:focus {
    background: #ff0000;
    border-color: #ff0000;
  }
  body.night-mode .stop-octagon-shape {
    fill: #222;
    stroke: #ff0000;
  }
  body.night-mode .stop-octagon-text {
    fill: #ff0000;
  }
  
  /* SkyView STOP button should always use night mode colors (red) */
  #stopBtn .stop-octagon-shape {
    fill: #222 !important;
    stroke: #ff0000 !important;
  }
  #stopBtn .stop-octagon-text {
    fill: #ff0000 !important;
  }
  
  /* Responsive tweaks for STOP button */
  @media (max-width: 700px) {
    .handpad-action-row {
      gap: 6em !important; /* Increased for medium screens */
      margin: 1.2em 0 0 0 !important;
    }
    .action-btn {
      width: 80px;
      height: 80px;
      min-width: 80px;
      min-height: 80px;
      font-size: 1.3em;
    }
    .stop-octagon-btn,
    .stop-octagon-btn--xlarge {
      width: 80px;
      height: 80px;
      min-width: 80px;
      min-height: 80px;
    }
    .stop-octagon-svg,
    .stop-octagon-svg--xlarge {
      width: 64px;
      height: 64px;
    }
    .stop-octagon-text--xlarge {
      font-size: 5vw;
      letter-spacing: 1px;
    }
  }
  @media (max-width: 500px) {
    .handpad-action-row {
      gap: 4em !important; /* Increased for small screens */
      margin: 1em 0 0 0 !important;
      flex-direction: row; /* Keep side by side even on small screens */
    }
    .action-btn {
      width: 60px;
      height: 60px;
      min-width: 60px;
      min-height: 60px;
      font-size: 1em;
    }
    .stop-octagon-btn,
    .stop-octagon-btn--xlarge {
      width: 60px;
      height: 60px;
      min-width: 60px;
      min-height: 60px;
    }
    .stop-octagon-svg,
    .stop-octagon-svg--xlarge {
      width: 44px;
      height: 44px;
    }
    .stop-octagon-text--xlarge {
      font-size: 7vw;
      letter-spacing: 0.7px;
    }
  }
  
  /* Only stack vertically on extremely small screens */
  @media (max-width: 320px) {
    .handpad-action-row {
      flex-direction: column;
      gap: 1em !important;
    }
  }
  /* End STOP octagon button styles */
  
  /* Additional robust night mode styles for cross-browser compatibility */
  body.night-mode {
    --tray-night-bg: #222;
    --tray-night-color: #ff0000;
    --tray-night-border: #ff0000;
  }
  
  /* Ultra-specific selectors to override any browser defaults */
  html body.night-mode div#controlTray button.tray-btn,
  html body.night-mode div#controlTray a.tray-btn,
  html body.night-mode div#controlTrayBtn {
    background-color: var(--tray-night-bg) !important;
    color: var(--tray-night-color) !important;
    border-color: var(--tray-night-border) !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
  }
  
  /* Force inheritance override */
  body.night-mode .tray-btn[style],
  body.night-mode #controlTrayBtn[style] {
    background: #222 !important;
    color: #ff0000 !important;
    border: 1.5px solid #ff0000 !important;
  }
  
  /* CSS animations disabled state override */
  body.night-mode .tray-btn:not(:active):not(:focus):not(:hover) {
    background: #222 !important;
    color: #ff0000 !important;
    border: 1.5px solid #ff0000 !important;
  }
</style>
<script>
  // Control Tray toggle logic
  $(function(){
    var $tray = $('#controlTray');
    var $btn = $('#controlTrayBtn');
    var $collapse = $('#controlTrayCollapse');
    
    // Ensure tray starts closed and button shows correct arrow
    $tray.addClass('hide').hide();
    $btn.html('&#x25C0;'); // Left arrow to indicate "open tray"
    
    function setArrow() {
      if ($tray.hasClass('hide')) {
        $btn.html('&#x25C0;'); // Left arrow = "open tray"
      } else {
        $btn.html('&#x25B6;'); // Right arrow = "close tray"
      }
    }
    
    $btn.on('click', function(){
      $tray.toggleClass('hide');
      setArrow();
      // If tray is now open, ensure it is visible
      if (!$tray.hasClass('hide')) {
        $tray.show();
      } else {
        $tray.hide();
      }
    });
    $(document).on('click', '#controlTrayCollapse', function(e) {
      $tray.addClass('hide');
      setArrow();
      $tray.hide();
      e.stopPropagation();
    });
    // Tray starts closed by default as configured above
  });
  </script>
  <script>
    // --- Control Tray visibility logic ---
    function updateTrayVisibility() {
      var mainVisible = document.getElementById('mainViewContainer').style.display !== 'none';
      document.getElementById('controlTrayBtn').style.display = mainVisible ? '' : 'none';
      document.getElementById('controlTray').style.display = mainVisible ? '' : 'none';
    }
    document.addEventListener('DOMContentLoaded', function() {
      updateTrayVisibility();
      // Main to SkyView
      var skyBtn = document.getElementById('skyviewButton');
      if (skyBtn) skyBtn.addEventListener('click', updateTrayVisibility);
      // SkyView to Main
      document.body.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'refreshBtn') updateTrayVisibility();
      });
    });
  </script>

</body>
</html>
