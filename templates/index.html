<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SiPi Telescope Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Modern Avalon-inspired stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <!-- SkyView styles (inline from skyview.html) -->
  <style>
    /* SkyView styles from skyview.html */
    html, body {
      margin:0; padding:0; overflow-x:hidden;
      background:black; color:white;
    }
    #skyviewContainer { display: none; position: relative; min-height: 100vh; background: black; color: white; }
    #skyviewTopBar {
      position:absolute; top:0; left:0; width:100vw;
      padding:10px; background:rgba(0,0,0,0.8);
      display:flex; gap:8px; align-items:center; z-index:20;
    }
    #skyviewTopBar input {
      width:6em; background:#222; color:#fff;
      border:1px solid #555; padding:2px 4px;
    }
    #skyviewTopBar button {
      background:#28a; color:#fff; border:none;
      padding:4px 8px; cursor:pointer;
    }
    #fullscreenBtn, #refreshBtn {
      position: absolute;
      top: 12px;
      z-index: 30;
      background: #28a;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
    }
    #refreshBtn { right: 90px; }
    #starAttributes {
      position:absolute; top:60px; left:10px; z-index:20;
      background:rgba(0,0,0,0.7); padding:8px; border-radius:4px;
      font-size:0.9em; line-height:1.4;
    }
    #starAttributes > div {
      display: none;
    }
    #starAttributes > div.active {
      display: block;
    }
    #toggleMenuBtn {
      position: fixed;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      z-index: 31;
      background: #28a;
      color: white;
      border: none;
      padding: 8px 18px;
      border-radius: 8px 8px 0 0;
      font-size: 1.1em;
      cursor: pointer;
      margin-bottom: 0;
      transition: bottom 0.25s;
    }
    #toggleBar {
      position: fixed;
      left: 50%;
      bottom: 48px;
      transform: translateX(-50%);
      z-index: 30;
      background: rgba(0,0,0,0.92);
      padding: 14px 18px 14px 18px;
      border-radius: 12px 12px 0 0;
      display: flex;
      flex-wrap: wrap;
      gap: 18px 24px;
      font-size: 1em;
      align-items: flex-start;
      box-sizing: border-box;
      width: 98vw;
      max-width: 600px;
      transition: transform 0.25s, opacity 0.25s;
      opacity: 1;
      pointer-events: auto;
    }
    #toggleBar.hide {
      opacity: 0;
      pointer-events: none;
      transform: translateX(-50%) translateY(100%);
    }
    #toggleBar:not(.hide) ~ #toggleMenuBtn {
      bottom: calc(14px + 2.5em + 24px);
    }
    #toggleBar label {
      display: flex;
      align-items: flex-start;
      margin-bottom: 0;
      min-width: 120px;
    }
    #toggleBar input {
      vertical-align: middle;
      margin-top: 2px;
      margin-right: 6px;
    }
    @media (max-width: 600px) {
      #toggleBar {
        flex-direction: column;
        align-items: flex-start;
        width: 98vw;
        left: 1vw;
        transform: none;
        max-width: none;
      }
      #toggleBar label {
        min-width: unset;
        width: 100%;
      }
      #toggleMenuBtn {
        left: 1vw;
        transform: none;
      }
    }
    #skyviewCanvas {
      display: block;
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      /* Place as low as possible above the Objects tray, with minimal gap */
      bottom: 18px;
      background: black;
      box-sizing: border-box;
      /* Maximize size: use all available width and height above tray, but always a circle */
      width: min(calc(100vw - 12px), calc(100vh - 110px));
      height: min(calc(100vw - 12px), calc(100vh - 110px));
      min-width: 200px;
      min-height: 200px;
      aspect-ratio: 1 / 1;
      z-index: 10;
      border-radius: 50%;
      box-shadow: 0 4px 24px 0 rgba(0,0,0,0.7);
    }
    #popup {
      position:absolute; background:rgba(0,0,0,0.8);
      color:black; padding:8px; border-radius:4px;
      font-family:sans-serif; display:none; z-index:40;
    }
    body.night-mode #popup {
      color: #ff0000 !important;
    }
    #popup button {
      margin-top:6px; padding:4px 8px;
      background:#28a; color:white; border:none;
      border-radius:3px; cursor:pointer;
    }
    #galFilterBar { display: none !important; visibility: hidden !important; height: 0 !important; width: 0 !important; overflow: hidden !important; position: absolute !important; }
  </style>

  <!-- Layout & style overrides -->
  <style>
    :root { --gap: 12px; --shadow: rgba(0,0,0,0.1); }

    /* Separator line */
    .separator {
      border: 0;
      border-top: 1px solid var(--shadow);
      margin: var(--gap) 0;
    }

    /* Center header buttons */
    .control-buttons {
      display: flex;
      justify-content: space-between;
      gap: var(--gap);
      margin: var(--gap) 0;
    }
    .control-buttons--center {
      justify-content: center !important;
    }
    .control-buttons-left, .control-buttons-right {
      display: flex;
      gap: var(--gap);
      align-items: center;
    }

    /* Single spacer (~3em) */
    .spacer {
      height: 3em;
    }

    /* Center search form rows */
    .search-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--gap);
    }
    .search-form__row,
    .search-actions {
      display: flex;
      gap: var(--gap);
      justify-content: center;
    }

    /* Blank spacer after SkyView/Model */
    .small-spacer {
      height: var(--gap);
    }

    /* Center GoTo & Close buttons */
    #goToBtn,
    #closeResultsBtn {
      display: inline-block;
      margin: var(--gap) 0.5em var(--gap) 0.5em;
    }

    /* Status panel layout */
    .status-panel {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--gap);
    }
    .status-panel__left,
    .status-panel__right {
      display: flex;
      flex-direction: column;
    }
    .status-panel__right {
      text-align: right;
    }

    /* Center & style Model panel */
    .model-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .model-panel__info,
    .model-panel__actions {
      display: flex;
      gap: var(--gap);
      justify-content: center;
    }

    /* Style all buttons */
    .btn {
      background-color: var(--surface);
      color: var(--fg);
      border: 1px solid var(--accent);
      padding: 0.5em 1em;
      cursor: pointer;
    }

    /* Handpad: make controls 50% larger */
    .btn--control {
      width: calc(var(--control-size) * 1.5) !important;
      height: calc(var(--control-size) * 1.5) !important;
      font-size: 1.5rem;
    }

    /* Space before Start/Park row */
    .handpad__row--actions {
      display: flex;
      justify-content: center;
      gap: calc(var(--gap) * 2) !important;
      margin-top: var(--gap);
    }

    /* Handpad SVG, arcs, and center styling */
    .handpad {
      width: 300px;
      height: 300px;
      margin: var(--gap) auto;
    }
    .handpad svg {
      width: 100%;
      height: 100%;
    }
    .handpad-arc,
    .handpad-center {
      fill: var(--surface) !important;
      stroke: var(--accent) !important;
      stroke-width: 2;
      cursor: pointer;
      fill-opacity: 0.3;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    /* Remove hover effect for handpad arcs and center: only activate on press */
    /* .handpad-arc:hover, .handpad-center:hover { fill: var(--accent) !important; fill-opacity: 0.4; } */
    }

    /* Speed label styling (larger & bold) */
    .speed-label {
      font-size: 1.25rem;
      font-weight: bold;
      fill: var(--fg) !important;
      pointer-events: none;
    }

    /* Day/Night mode styles */
    body.night-mode {
      background: #111 !important;
      color: #ff0000 !important;
    }
    .status-panel {
      background: #f5f5f5;
      color: #111;
    }
    body.night-mode .status-panel {
      background: #222;
      color: #ff0000;
    }
    /* SkyView night mode overrides */
    #skyviewContainer {
      background: #000 !important;
      color: #ff0000 !important;
    }
    body.night-mode #skyviewContainer {
      background: #000 !important;
      color: #ff0000 !important;
    }
    #skyviewContainer label,
    #skyviewContainer span,
    #skyviewContainer div,
    #skyviewContainer input,
    #skyviewContainer button {
      color: inherit;
    }
    #skyviewContainer button {
      background: #222 !important;
      color: #ff0000 !important;
      border-radius: 8px !important;
      border: 1.5px solid #ff0000 !important;
      min-width: 38px;
      min-height: 38px;
      width: 38px;
      height: 38px;
      padding: 0;
      font-size: 1.2em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    #skyviewContainer button#toggleMenuBtn {
      width: auto;
      min-width: 90px;
      height: 38px;
      border-radius: 8px 8px 0 0 !important;
      margin-bottom: 0;
      padding: 0 18px;
      font-size: 1.1em;
    }
    #skyviewContainer input[type="text"] {
      background: #222 !important;
      color: #ff0000 !important;
      border: 1.5px solid #ff0000 !important;
      border-radius: 6px;
      padding: 2px 4px;
    }
    /* SkyView night mode checkboxes: red border, black center if off, red center if on */
    #skyviewContainer input[type="checkbox"] {
      width: 18px;
      height: 18px;
      border: 2px solid #ff0000 !important;
      background: #000 !important;
      border-radius: 4px;
      appearance: none;
      outline: none;
      cursor: pointer;
      position: relative;
      margin-right: 6px;
      vertical-align: middle;
      transition: background 0.15s, border 0.15s;
    }
    #skyviewContainer input[type="checkbox"]:checked {
      background: #ff0000 !important;
      border: 2px solid #ff0000 !important;
    }
    #skyviewContainer input[type="checkbox"]:checked::after {
      content: '';
      display: block;
      position: absolute;
      left: 4px;
      top: 1.5px;
      width: 6px;
      height: 10px;
      border: solid #000;
      border-width: 0 3px 3px 0;
      transform: rotate(45deg);
    }
    #skyviewContainer input[type="checkbox"]:not(:checked)::after {
      content: '';
      display: block;
      position: absolute;
      left: 4px;
      top: 1.5px;
      width: 6px;
      height: 10px;
      border: none;
    }
    #skyviewContainer label {
      color: #ff0000 !important;
    }
    #skyviewTopBar {
      background: rgba(0,0,0,0.85) !important;
    }
    #starAttributes {
      background: rgba(0,0,0,0.7) !important;
      color: #ff0000 !important;
    }
    #popup {
      background: rgba(0,0,0,0.8) !important;
      color: #ff0000 !important;
    }
    /* Ensure all buttons are square and rounded */
    #refreshBtn {
      border-radius: 8px !important;
      width: 38px;
      height: 38px;
      min-width: 38px;
      min-height: 38px;
      padding: 0;
      font-size: 1.2em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Search results styling */
    .search-results__info {
      background: #222;
      color: #ff0000;
      padding: 12px 18px;
      border-radius: 8px 8px 0 0;
      text-align: center;
      font-size: 1.08em;
      margin-top: 10px;
    }
    .search-results__actions {
      background: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 14px 0 18px 0;
      border-radius: 0 0 8px 8px;
      margin-bottom: 10px;
    }
    .search-results__actions--horizontal {
      flex-direction: row !important;
      justify-content: center;
      align-items: center;
      gap: 18px;
      padding: 14px 0 18px 0;
    }
    .search-results__actions .btn {
      background: var(--surface, #222);
      color: #ff0000;
      border: 1.5px solid #ff0000;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      text-align: center;
      padding: 0 16px;
    }
    .search-results__actions .btn:active {
      background: #333;
    }
    .search-results__none {
      background: #222;
      color: #ff0000;
      padding: 14px 18px;
      border-radius: 8px;
      text-align: center;
      margin-top: 10px;
    }
  </style>

  <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/skyview.js') }}" defer></script>
</head>
<body>
  <script type="text/javascript">
    // Injected settings flags
    var _vibrationEnabled = typeof vibration_enabled !== "undefined" ? vibration_enabled : false;
    var vibrationEnabled = typeof _vibrationEnabled !== "undefined" ? _vibrationEnabled : false;
    var _tiltEnabled = typeof tilt_enabled !== "undefined" ? tilt_enabled : false;
    var tiltEnabled = (typeof _tiltEnabled !== "undefined") ? _tiltEnabled : false;
    console.log("vibrationEnabled =", vibrationEnabled, "tiltEnabled =", tiltEnabled);
  </script>

  <div id="mainViewContainer">
    <div class="container">

      <!-- STATUS PANEL -->
      <div id="status" class="status-panel"></div>

      <hr class="separator">

      <!-- SEARCH + SKYVIEW / MODEL -->
      <div id="controlPanel" class="control-panel">
        <form id="searchForm" class="search-form" autocomplete="off">
          <!-- Search row -->
          <div class="search-form__row search-form__row--with-clear search-form__row--relative">
            <div class="search-input-wrapper">
              <input type="text"
                     id="searchQuery"
                     class="search-form__input"
                     placeholder="Enter object name…"
                     required
                     autocomplete="off">
              <button type="button" id="clearSearchBtn" aria-label="Clear search">&times;</button>
            </div>
            <button type="submit" class="btn btn--primary">Search</button>
          </div>
  <style>
    .search-form__row--relative { position: relative; }
    .search-input-wrapper {
      position: relative;
      display: flex;
      align-items: stretch;
      flex: 1 1 auto;
      width: 100%;
      height: 2.4em; /* Match input height */
    }
    .search-form__input {
      width: 18em;
      min-width: 120px;
      padding-right: 2.2em;
      box-sizing: border-box;
      height: 2.4em;
      line-height: 2.4em;
      font-size: 1em;
      /* Remove vertical-align if present */
    }
    #clearSearchBtn {
      display: none;
      position: absolute;
      right: 0.35em;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      font-size: 1.25em;
      color: #888;
      cursor: pointer;
      z-index: 2;
      padding: 0;
      line-height: 1;
      height: 1.6em;
      width: 1.6em;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #clearSearchBtn:active { color: #f33; }
    .search-form__row--with-clear .btn--primary {
      margin-left: 0.5em;
    }
    @media (max-width: 600px) {
      .search-form__input { width: 100%; min-width: 0; }
    }
  </style>
          <div id="results" class="search-results"></div>
          <!-- SkyView/Model row -->
          <div class="search-actions">
            <button type="button" id="skyviewButton" class="btn btn--secondary">SkyView</button>
            <button type="button" id="modelButton"   class="btn btn--secondary">Model</button>
          </div>
          <div class="small-spacer"></div>
        </form>

        <div id="modelPanel" class="model-panel hidden">
          <div class="model-panel__info">
            <span>Cal Pts: <strong id="modelCalPts">0</strong></span>
            <span>RMS:    <strong id="modelRMS">0</strong></span>
          </div>
          <div class="model-panel__actions">
            <button id="calptButton" class="btn">+ Cal Pt</button>
            <button id="delCalptButton" class="btn">- Cal Pt</button>
            <button id="clearButton" class="btn">Clear</button>
            <button id="saveButton"  class="btn">Save</button>
          </div>
        </div>
      </div>

      <hr class="separator">

      <!-- HANDPAD / MOVEMENT CONTROLS -->
      <div id="directionControl" class="handpad"></div>

      <!-- Control Tray for Mode/Park (right edge, handpad height) -->
      <div id="controlTrayBtn" title="Show/hide controls">&#x25C0;</div>
      <div id="controlTray" class="hide">
        <button id="controlTrayCollapse" title="Collapse tray" class="tray-collapse-btn">&#x25B6;</button>
        <button class="tray-btn" id="modeToggleButton">Manual</button>
        <button class="tray-btn" id="parkToggleButton">Park</button>
        <button class="tray-btn" id="editConfigBtn" title="Settings">⚙</button>
        <button class="tray-btn" id="toggleFullScreen" title="Fullscreen">⛶</button>
        <button class="tray-btn" id="toggleMode" title="Day/Night">🌙</button>
        <a class="tray-btn" id="helpBtn" title="Help" href="{{ url_for('quickstart') }}" target="_blank" rel="noopener">Help</a>
      </div>

      <!-- START and STOP BUTTONS below Handpad -->
      <div class="handpad-action-row">
        <button id="startButton" class="action-btn start-action-btn">START</button>
        <button id="trackToggleButton" title="Stop" aria-label="Stop" class="action-btn stop-octagon-btn stop-octagon-btn--xlarge">
          <svg class="stop-octagon-svg stop-octagon-svg--xlarge" width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <polygon class="stop-octagon-shape" points="30.18,5 69.82,5 95,30.18 95,69.82 69.82,95 30.18,95 5,69.82 5,30.18"/>
            <text class="stop-octagon-text stop-octagon-text--xlarge" x="50" y="56" text-anchor="middle" font-size="40" font-family="'Arial Black', Arial, sans-serif" font-weight="900" letter-spacing="1.2" fill="#111" dominant-baseline="middle">STOP</text>
          </svg>
        </button>
      </div>

      <!-- Single spacer -->
      <div class="spacer"></div>

      <!-- Config/Fullscreen/Day-Night (removed, now in tray) -->

      <!-- MODAL DIALOG -->
      <div id="customModal" class="modal hidden">
        <div class="modal__content"></div>
      </div>
    </div>
  </div>

  <!-- SKYVIEW CONTAINER (hidden by default) -->
  <div id="skyviewContainer" style="display:none;">
    <div id="skyviewTopBar">
      <label>Alt: <input id="gotoAlt" type="text" placeholder="DD:MM:SS"></label>
      <label>Az:  <input id="gotoAz"  type="text" placeholder="DD:MM:SS"></label>
      <button id="gotoCoordsBtn">GoTo</button>
    </div>
    <div class="skyview-bottom-btns">
      <div class="skyview-btn-vertical">
        <button id="stopBtn" title="Stop" aria-label="Stop" class="skyview-btn skyview-btn--stop">
          <svg class="stop-octagon-svg" width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
            <polygon class="stop-octagon-shape" points="12.07,2 27.93,2 38,12.07 38,27.93 27.93,38 12.07,38 2,27.93 2,12.07" style="stroke-width:1;"/>
            <text class="stop-octagon-text" x="20" y="21.5" text-anchor="middle" font-size="5" font-family="'Arial Black', Arial, sans-serif" font-weight="900" letter-spacing="0.5" fill="#111" dominant-baseline="middle">STOP</text>
          </svg>
        </button>
        <button id="backBtn" title="Back" aria-label="Back" class="skyview-btn skyview-btn--icon"><span style="width:40px;height:40px;line-height:40px;display:inline-block;text-align:center;font-size:1.2em;">&#8592;</span></button>
        <button id="redrawBtn" title="Redraw" aria-label="Redraw" class="skyview-btn skyview-btn--icon"><span style="width:40px;height:40px;line-height:40px;display:inline-block;text-align:center;font-size:1.2em;">&#8635;</span></button>
      </div>
    </div>
  <style>
    .skyview-bottom-btns {
      position: absolute;
      bottom: 18px;
      right: 18px;
      z-index: 30;
    }
    .skyview-btn-vertical {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
    }
    .skyview-btn {
      background: #28a;
      color: #fff;
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      min-width: 40px;
      min-height: 40px;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0;
      box-sizing: border-box;
      transition: background 0.15s, color 0.15s;
      padding: 0;
      overflow: hidden;
    }
    .skyview-btn--stop {
      background: transparent;
      padding: 0;
    }
    .skyview-btn--icon {
      background: #28a;
    }
    .stop-octagon-svg {
      width: 40px;
      height: 40px;
      display: block;
    }
    @media (max-width: 600px) {
      .skyview-btn {
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
        font-size: 1em;
      }
      .skyview-bottom-btns {
        bottom: 56px; /* 1.5 * 32px button height, moves up for visibility */
        right: 8px;
      }
      .skyview-btn-vertical {
        gap: 8px;
      }
      .stop-octagon-svg {
        width: 32px;
        height: 32px;
      }
      .skyview-btn--icon span {
        width: 32px !important;
        height: 32px !important;
        line-height: 32px !important;
        font-size: 1em !important;
      }
    }
    /* Remove duplicate STOP/Back/Redraw button rules to prevent hidden/extra buttons */
  </style>
    <div id="starAttributes">
      <div id="nameInfo">Name: </div>
      <div id="hipInfo">HIP: </div>
      <div id="hdInfo">HD: </div>
      <div id="hrInfo">HR: </div>
      <div id="specInfo">Spectral Type: </div>
      <div id="colorInfo">Color Index: </div>
      <div id="distInfo">Distance: </div>
      <div id="magInfo">Magnitude: </div>
    </div>
    <button id="toggleMenuBtn">Objects &#x25BC;</button>
    <div id="toggleBar" class="hide">
      <label><input type="checkbox" id="toggleStars" checked> Stars</label>
      <label><input type="checkbox" id="toggleConst"> Constellations</label>
      <label style="margin-left:0.5em;"><input type="checkbox" id="toggleConstLabels" checked> Names</label>
      <label><input type="checkbox" id="toggleGal"> Galaxies</label>
      <label><input type="checkbox" id="toggleOpen"> Open Clusters</label>
      <label><input type="checkbox" id="toggleGlobular"> Globular Clusters</label>
      <label><input type="checkbox" id="toggleNebula"> Nebulae</label>
      <label><input type="checkbox" id="togglePlanetary"> Planetary Nebulae</label>
      <label><input type="checkbox" id="toggleCalPoints" checked> Calibration Points</label>
    </div>
    <canvas id="skyviewCanvas"
            data-latitude="{{ site_latitude }}"
            data-longitude="{{ site_longitude }}">
    </canvas>
    <div id="popup"></div>
  </div>

  <script>
  $(function(){
    // Insert header buttons
    $('.control-buttons').html(`
      <div class="control-buttons-left">
        <button class="btn btn--icon" id="editConfigBtn"    title="Settings">⚙</button>
        <button class="btn btn--icon" id="toggleFullScreen" title="Fullscreen">⛶</button>
        <button class="btn btn--icon" id="toggleMode"        title="Day/Night">🌙</button>
      </div>
      <div class="control-buttons-right"></div>
    `);

    // Modal helpers
    function showModal(html) {
      $('#customModal .modal__content').html(html);
      $('#customModal').removeClass('hidden');
    }
    function hideModal() {
      $('#customModal').addClass('hidden');
    }
    window.hideModal = hideModal;

    function customAlert(msg) {
      showModal(
        '<div class="modal__body">' + msg + '</div>' +
        '<div class="modal__footer">' +
          '<button class="btn" onclick="hideModal()">OK</button>' +
        '</div>'
      );
    }

    // Night-mode toggle
    function applyNight(){
      var on = localStorage.getItem('nightMode')==='enabled';
      $('body').toggleClass('night-mode', on);
      $('#toggleMode').text(on?'☀':'🌙');
    }
    applyNight();
    window.addEventListener('storage', function(e){
      if(e.key==='nightMode') applyNight();
    });
    $('#toggleMode').click(function(){
      var on = !$('body').hasClass('night-mode');
      localStorage.setItem('nightMode', on?'enabled':'disabled');
      applyNight();
    });

    // Fullscreen & Settings
    $('#toggleFullScreen').click(function(){
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    });
    $('#editConfigBtn').click(function(){
      window.location.href = "{{ url_for('edit_config') }}";
    });

    // Update Status Panel
    function updateStatus() {
      $.getJSON('/status', function(d){
        function hmsToSec(hms) {
          var p = hms.split(':').map(Number);
          return p[0]*3600 + p[1]*60 + p[2];
        }
        function secToHms(s) {
          s = ((s % 86400) + 86400) % 86400;
          var h = Math.floor(s/3600),
              m = Math.floor((s%3600)/60),
              sec = Math.floor(s%60);
          return [h,m,sec].map(x => String(x).padStart(2,'0')).join(':');
        }
        var haSec = hmsToSec(d.sidereal) - hmsToSec(d.ra),
            haStr = secToHms(haSec);

        $('#status').html(
          '<div class="status-panel__left">'+
            '<div>RA: '+d.ra+' | DEC: '+d.dec+'</div>'+
            '<div>Alt: '+d.alt+' | Az: '+d.az+'</div>'+
            '<div>Status: '+d.tracking+'</div>'+
          '</div>'+
          '<div class="status-panel__right">'+
            '<div>Time: '+d.time+'</div>'+
            '<div>LST:  '+d.sidereal+'</div>'+
            '<div>HA:   '+haStr+'</div>'+
          '</div>'
        );

        // $('#trackToggleButton').text('STOP'); // Removed to preserve SVG STOP button markup
        // Remove old label updates for mode/park buttons
        // $('#parkToggleButton').text((d.tracking==='Parking'||d.tracking==='Parked')?'Unpark':'Park');
        // $('#modeToggleButton').text(d.tracking==='Blinky'?'Auto':'Manual');
      });
    }
    setInterval(updateStatus, 500);
    updateStatus();

    // Update Mode and Park/Unpark button labels (full text)
    function updateModeAndParkButtons() {
      $.getJSON('/status', function(d) {
        var isManual = d.tracking === 'Blinky';
        // Swap labels: show 'Auto' when manual, 'Manual' when auto
        $('#modeToggleButton').text(isManual ? 'Auto' : 'Manual');
        var isParked = d.tracking === 'Parking' || d.tracking === 'Parked';
        $('#parkToggleButton').text(isParked ? 'Unpark' : 'Park');
      });
    }
    setInterval(updateModeAndParkButtons, 500);
    updateModeAndParkButtons();

    // Search handler
    $('#searchForm').submit(function(e){
      e.preventDefault();
      var q = $('#searchQuery').val().trim();
      if(!q) return customAlert("Enter an object name.");
      $.post('/search',{query:q}, function(data){
        window.searchResults = data.results;
        // Only show the selection popup if not just synced
        if (window.justSynced) {
          window.justSynced = false;
          if(data.results.length===1){
            selectSearchResult(0);
          } else if(data.results.length===0){
            $('#results').html('<div class="search-results__none">No results found.</div>');
          }
          return;
        }
        if(data.results.length>1){
          var html = '<div class="modal__body"><h3>Select result</h3>';
          data.results.forEach((it,i) => {
            html += '<button class="btn btn--full" onclick="selectSearchResult('+i+')">'+it.rawResult+'</button>';
          });
          html += '</div>';
          showModal(html);
        } else if(data.results.length===1){
          selectSearchResult(0);
        } else {
          $('#results').html('<div class="search-results__none">No results found.</div>');
        }
      }, 'json');
    });

    // Select & display a single result
    window.selectSearchResult = function(i) {
      var it = window.searchResults[i];
      window.currentRA  = it.raw_ra;
      window.currentDEC = it.raw_dec;
      $('#results').html(
        '<div class="search-results__info">'+
          'RA: '+it.ra+' | DEC: '+it.dec+
          (it.alt?' | Alt: '+it.alt:'')+
          (it.az?' | Az: '+it.az:'')+
          (it.info?' | '+it.info:'')+
        '</div>'+
        '<div class="search-results__actions search-results__actions--horizontal">'+
          '<button id="syncButton" class="btn">Sync</button>'+ 
          '<button id="goToBtn" class="btn btn--primary">GoTo</button>'+ 
          '<button id="closeResultsBtn" class="btn btn--secondary">X</button>'+ 
        '</div>'
      );
      $('#syncButton').off('click').on('click',function(){
        if(window.currentRA && window.currentDEC) {
          window.justSynced = true;
          $.post('/sync',{ra:window.currentRA,dec:window.currentDEC});
        }
      });
      $('#goToBtn').off('click').on('click',function(){
        $.post('/goto',{ra:it.raw_ra,dec:window.currentDEC});
      });
      $('#closeResultsBtn').off('click').on('click',function(){
        $('#results').empty();
      });
      hideModal();
      // Clear searchResults after a selection to prevent popup reappearing
      setTimeout(function(){ window.searchResults = []; }, 0);
    };

    // SkyView toggle logic
    $('#skyviewButton').off('click').on('click', function() {
      $('#mainViewContainer').hide();
      $('#skyviewContainer').show();
      // Force SkyView JS to re-initialize if needed
      if (typeof window.dispatchEvent === 'function') {
        setTimeout(function() {
          window.dispatchEvent(new Event('resize'));
        }, 100);
      }
    });
    // SkyView Stop button
    $('#stopBtn').off('click').on('click', function() {
      $.post('/abort');
    });
    // Back arrow in SkyView (handled in skyview.js as well)
    $('#refreshBtn').off('click').on('click', function() {
      $('#skyviewContainer').hide();
      $('#mainViewContainer').show();
    });
    // SkyView menu toggle
    var toggleMenuBtn = document.getElementById('toggleMenuBtn');
    var toggleBar = document.getElementById('toggleBar');
    if(toggleMenuBtn && toggleBar) {
      toggleMenuBtn.addEventListener('click', function() {
        toggleBar.classList.toggle('hide');
        toggleMenuBtn.textContent = toggleBar.classList.contains('hide') ? 'Objects \u25b2' : 'Objects \u25bc';
      });
    }

    // Model panel controls
    $('#modelButton').click(function(){
      var panel = $('#modelPanel');
      panel.toggleClass('hidden');
      if(!panel.hasClass('hidden')) updateModelInfo();
    });
    function updateModelInfo(){
      $.post('/getModelInfo', function(d){
        $('#modelCalPts').text(d.cal_pts);
        $('#modelRMS').text(d.rms);
      }, 'json');
    }
    setInterval(()=>{ if(!$('#modelPanel').hasClass('hidden')) updateModelInfo(); },5000);

    $('#calptButton').click(()=>{ if(window.currentRA&&window.currentDEC) $.post('/calpt',{ra:window.currentRA,dec:window.currentDEC}); });
    $('#delCalptButton').off('click').on('click', function(){
      $.post('/RemoveLastCalPoint', function(resp){
        if (typeof updateModelInfo === 'function') updateModelInfo();
      });
    });
    // --- Clear Model button with confirmation ---
    $('#clearButton').click(function(){
      showModal(
        `<div class="modal__body">
          <strong>Clear Model?</strong>
          <div style="margin-top:10px;">This will erase all calibration points.<br>Are you sure?</div>
         </div>
         <div class="modal__footer">
          <button class="btn btn--primary" id="confirmClearBtn">Yes, Clear</button>
          <button class="btn" onclick="hideModal()">Cancel</button>
         </div>`
      );
      $('#confirmClearBtn').off('click').on('click', function() {
        $.post('/clear', function(resp){
          customAlert("Model cleared.");
          updateModelInfo && updateModelInfo();
        });
        hideModal();
      });
    });
    // --- End Clear Model logic ---
    $('#saveButton').click(()=>$.post('/save_model', ()=>customAlert("Model saved"), 'json'));

    // Movement controls
    function sendMove(axis,arg){ $.post('/moveaxis',{axis:axis,arg:arg}); }
    function startMove(axis,dir,btn){
      var code = window.currentSpeed==="Slew"
        ? ((dir==="down"||dir==="right")?"S":"s")
        : window.currentSpeed==="Pan"
          ? ((dir==="down"||dir==="right")?"P":"p")
          : ((dir==="down"||dir==="right")?"G":"g");
      sendMove(axis,code);
      if(vibrationEnabled) navigator.vibrate?.(150);
      var id = setInterval(()=>{
        sendMove(axis,code);
        if(vibrationEnabled) navigator.vibrate?.(150);
      },200);
      $(btn).data('intervalId',id);
    }
    function stopMove(axis,btn){
      var id = $(btn).data('intervalId');
      if(id) clearInterval(id);
      if(vibrationEnabled) navigator.vibrate?.(0);
      sendMove(axis,"");
    }
    var speeds=["Slew","Pan","Guide"];
    window.currentSpeedIndex=0;
    window.currentSpeed=speeds[0];

    // Render SVG handpad with 4 wide, spaced arcs at up/down/left/right (not corners)
    // Each arc is a quarter of a ring, centered on 0, 90, 180, 270 deg, with square gaps
    // --- Handpad geometry tweaks for more space and square gaps ---
    const arcOuterR = 182.5; // 50% wider arcs (was 150)
    const arcInnerR = 85; // restore original inner radius
    const arcGapDeg = 22; // larger gap for more square separation
    const arcSweep = 90 - arcGapDeg;
    const center = 200;
    function describeArc(cx, cy, r1, r2, startAngle, sweep) {
      // Returns SVG path for a ring sector (arc with thickness)
      const toRad = a => (a-90)*Math.PI/180.0;
      const endAngle = startAngle + sweep;
      const x1 = cx + r1 * Math.cos(toRad(startAngle));
      const y1 = cy + r1 * Math.sin(toRad(startAngle));
      const x2 = cx + r1 * Math.cos(toRad(endAngle));
      const y2 = cy + r1 * Math.sin(toRad(endAngle));
      const x3 = cx + r2 * Math.cos(toRad(endAngle));
      const y3 = cy + r2 * Math.sin(toRad(endAngle));
      const x4 = cx + r2 * Math.cos(toRad(startAngle));
      const y4 = cy + r2 * Math.sin(toRad(startAngle));
      const largeArc = sweep > 180 ? 1 : 0;
      return [
        "M", x1, y1,
        "A", r1, r1, 0, largeArc, 1, x2, y2,
        "L", x3, y3,
        "A", r2, r2, 0, largeArc, 0, x4, y4,
        "Z"
      ].join(" ");
    }
    const arcDefs = [
      {id:'upButton',    start: -arcSweep/2,        angle: 0},
      {id:'rightButton', start: 90-arcSweep/2,      angle: 90},
      {id:'downButton',  start: 180-arcSweep/2,     angle: 180},
      {id:'leftButton',  start: 270-arcSweep/2,     angle: 270}
    ];
    let arcPaths = arcDefs.map(a => `<path id="${a.id}" class="handpad-arc" d="${describeArc(center,center,arcOuterR,arcInnerR,a.start,arcSweep)}"/>`).join("\n");
    // --- Speed button: smaller, styled like arcs ---
    const speedBtnR = arcInnerR - 28; // smaller for more gap
    $('#directionControl').html(`
      <svg class="handpad" viewBox="0 0 400 400" width="340" height="340">
        ${arcPaths}
        <circle id="speedButton" class="handpad-center" cx="200" cy="200" r="${speedBtnR}"/>
        <text x="200" y="200" text-anchor="middle" dominant-baseline="central" class="speed-label">${window.currentSpeed}</text>
      </svg>
      <div class="handpad__row handpad__row--actions">
        <!-- Removed STOP button from here -->
      </div>
    `);
    // Update handpad SVG style injection for night mode red
    $("<style id='handpadArcStyle'>\n"
      // Day mode: blue border, gray background, black text
      + ".handpad-arc, .handpad-center {\n"
      + "  stroke: #28a !important;\n"
      + "  stroke-width: 2.5 !important;\n"
      + "  fill: #f5f5f5 !important;\n"
      + "  opacity: 1;\n"
      + "  cursor: pointer;\n"
      + "  transition: opacity 0.15s, fill 0.15s, stroke 0.15s;\n"
      + "}\n"
      + ".speed-label { font-size: 2.1em; font-weight: bold; fill: #111 !important; pointer-events: none; }\n"
      // Night mode: dark bg, #ff0000 border/text
      + "body.night-mode .handpad-arc, body.night-mode .handpad-center {\n"
      + "  stroke: #ff0000 !important;\n"
      + "  fill: #222 !important;\n"
      + "}\n"
      + "body.night-mode .speed-label { fill: #ff0000 !important; }\n"
      + "</style>").appendTo('head');
    // Remove any old handpadGridStyle
    $('style#handpadGridStyle').remove();
    // Bind directional arcs
    ['up','right','down','left'].forEach(dir=>{
      let axis = (dir==='up'||dir==='down')?"Sec":"Pri";
      // Remove any previous handlers to avoid duplicates
      $('#'+dir+'Button').off('pointerdown').on('pointerdown', function(e){
        e.preventDefault();
        startMove(axis,dir,this);
      });
      $('#'+dir+'Button').off('pointerup pointercancel pointerleave').on('pointerup pointercancel pointerleave', function(e){
        stopMove(axis,this);
      });
    });
    // Speed toggle
    $('#speedButton').click(function(){
      window.currentSpeedIndex=(window.currentSpeedIndex+1)%speeds.length;
      window.currentSpeed=speeds[window.currentSpeedIndex];
      $('.speed-label').text(window.currentSpeed);
    });

    // Dismiss modal if backdrop clicked
    $('#customModal').click(e=>{ if(e.target.id==='customModal') hideModal(); });


    // Remove focus outline after click
    $('button').click(function(){ this.blur(); });

    // --- Search clear button logic ---
    var $search = $('#searchQuery');
    var $clearBtn = $('#clearSearchBtn');
    function toggleClearBtn() {
      $clearBtn[$search.val().length > 0 ? 'show' : 'hide']();
    }
    $search.on('input', toggleClearBtn);
    $clearBtn.on('click', function() {
      $search.val('');
      $search.focus();
      toggleClearBtn();
      $('#results').empty();
    });
    toggleClearBtn();

    // --- System Time Popup on First Boot ---
    // Fetch /status to get boot/session ID
    $.getJSON('/status', function(d) {
      var bootId = d.boot_id || d.bootid || d.session_id || d.sessionid || d.boot || null;
      if (!bootId) return; // backend must provide this
      var lastBootId = localStorage.getItem('lastBootId');
      if (lastBootId !== bootId) {
        // Show modal asking to set system time
        var deviceTime = new Date();
        var timeStr = deviceTime.toLocaleString();
        var isNight = $('body').hasClass('night-mode');
        var modalHtml = `
          <div class="modal__body${isNight ? ' night-mode' : ''}"
            style="${isNight ? 'color:#f33; background:#222; border-radius:8px; padding:10px 0;' : 'color:#111; background:#f5f5f5; border-radius:8px; padding:10px 0;'}">
            <strong>Set System Time?</strong>
            <div style="margin-top:10px;">Would you like to set the Pi's system time to your device's current time?</div>
            <div style="margin-top:10px; font-size:1.1em;">Device time: <span style="font-weight:bold;">${timeStr}</span></div>
          </div>
          <div class="modal__footer"
            style="${isNight ? 'background:#222; color:#f33; border-radius:0 0 8px 8px; padding:10px 0; text-align:center;' : 'background:#f5f5f5; color:#111; border-radius:0 0 8px 8px; padding:10px 0; text-align:center;'}">
            <button class="btn btn--primary" id="setSystemTimeBtn">Set Time</button>
            <button class="btn" id="dismissTimeBtn">Dismiss</button>
          </div>
        `;
        showModal(modalHtml);
        $('#setSystemTimeBtn').off('click').on('click', function() {
          // Send device time as local dt_str (YYYY-MM-DD HH:MM:SS)
          function pad(n) { return n.toString().padStart(2, '0'); }
          const dt_str = deviceTime.getFullYear() + '-' + pad(deviceTime.getMonth()+1) + '-' + pad(deviceTime.getDate()) + ' ' + pad(deviceTime.getHours()) + ':' + pad(deviceTime.getMinutes()) + ':' + pad(deviceTime.getSeconds());
          $.ajax({
            url: '/set_time',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ dt_str }),
            success: function() {
              customAlert('System time set!');
              localStorage.setItem('lastBootId', bootId);
            },
            error: function() {
              customAlert('Failed to set system time.');
            }
          });
          hideModal();
        });
        $('#dismissTimeBtn').off('click').on('click', function() {
          localStorage.setItem('lastBootId', bootId);
          hideModal();
        });
      }
    });
  });
  </script>

  <script>
    // --- Track/Stop button logic ---
    $(document).on('click', '#trackToggleButton', function() {
      // Only stop
      $.post('/abort');
    });

    // --- Start button logic (tray) ---
    $(document).on('click', '#startButton', function() {
      $.post('/start');
    });

    // --- Manual/Auto and Park/Unpark button logic ---
    $(document).on('click', '#modeToggleButton', function() {
      $.post('/toggle_mode', function(d) {
        // Optionally update label immediately
        $('#modeToggleButton').text(d.mode === 'Manual' ? 'Manual' : 'Auto');
      }, 'json');
    });
    $(document).on('click', '#parkToggleButton', function() {
      var label = $(this).text().trim().toLowerCase();
      if(label === 'park') {
        $.post('/park');
      } else {
        $.post('/unpark');
      }
    });
  </script>

  <!-- Control Tray Styles -->
  <style>
    /* Control Tray Styles */
    #controlTrayBtn {
      position: fixed;
      top: 50%;
      right: 0;
      transform: translateY(-50%);
      background: #f5f5f5;
      color: #111;
      border-radius: 8px 0 0 8px;
      border: 1.5px solid #28a;
      padding: 0 8px;
      font-size: 2.1em;
      cursor: pointer;
      z-index: 2000;
      box-shadow: -2px 2px 8px rgba(0,0,0,0.18);
      width: 38px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: background 0.15s, color 0.15s, border 0.15s;
    }
    #controlTrayBtn:active, #controlTrayBtn:focus {
      background: #e0eaff;
      color: #111;
      border-color: #1a5a8a;
    }
    body.night-mode #controlTrayBtn {
      background: #222;
      color: #ff0000;
      box-shadow: -2px 2px 8px rgba(255,0,0,0.18);
      border: 1.5px solid #ff0000;
    }
    body.night-mode #controlTrayBtn:active, body.night-mode #controlTrayBtn:focus {
      background: #ff0000;
      color: #111;
      border-color: #ff0000;
    }
    #controlTray {
      position: fixed;
      top: calc(50% + 160px); /* Move drawer down by about four button heights (incremented again) */
      right: 0;
      transform: translateY(-50%);
      background: #f5f5f5;
      border-radius: 16px 0 0 16px;
      box-shadow: -2px 2px 16px rgba(0,0,0,0.22);
      padding: 16px 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
      z-index: 2001;
      min-width: 0;
      width: 120px;
      max-width: 140px;
      transition: right 0.25s, opacity 0.25s;
      border: 1.5px solid #28a;
    }
    #controlTray.hide {
      right: -140px;
      opacity: 0;
      pointer-events: none;
    }
    body.night-mode #controlTray {
      background: rgba(34,34,34,0.98);
      box-shadow: -2px 2px 16px rgba(255,0,0,0.22);
      border: 1.5px solid #ff0000;
    }
    .tray-btn {
      font-size: 1.08em;
      padding: 10px 0;
      border-radius: 8px;
      background: #f5f5f5;
      color: #111;
      border: 1.5px solid #28a;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      min-width: 90px;
      width: 100%;
      font-weight: bold;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border 0.15s;
      text-align: center;
    }
    .tray-btn:active, .tray-btn:focus {
      background: #e0eaff;
      color: #111;
      border-color: #1a5a8a;
    }
    .tray-collapse-btn {
      background: #f5f5f5 !important;
      color: #111 !important;
      border: 1.5px solid #28a !important;
      box-shadow: none !important;
      font-size: 2.1em !important;
      width: 38px !important;
      min-width: 38px !important;
      height: 38px !important;
      min-height: 38px !important;
      padding: 0 !important;
      align-self: center;
      margin-top: 10px;
      margin-bottom: 0;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px !important;
      transition: background 0.15s, color 0.15s, border 0.15s;
    }
    .tray-collapse-btn:active, .tray-collapse-btn:focus {
      background: #e0eaff !important;
      color: #111 !important;
      border-color: #1a5a8a !important;
    }
    body.night-mode .tray-collapse-btn {
      color: #ff0000 !important;
      background: transparent !important;
      border: 1.5px solid #ff0000 !important;
    }
    body.night-mode .tray-collapse-btn:active, body.night-mode .tray-collapse-btn:focus {
      color: #fff !important;
      background: #ff0000 !important;
      border: 1.5px solid #ff0000 !important;
    }
    .tray-btn:active, .tray-btn:focus {
      background: #1a5a8a;
      color: #eee;
    }
    body.night-mode .tray-btn {
      background: #222;
      color: #ff0000;
      box-shadow: 0 2px 8px rgba(255,0,0,0.18);
      border: 1.5px solid #ff0000;
    }
    body.night-mode .tray-btn:active, body.night-mode .tray-btn:focus {
      background: #ff0000;
      color: #111;
    }
    @media (max-width: 700px) {
      #controlTray, #controlTrayBtn {
        top: calc(50% + 80px); /* Move drawer down even more on mobile too (double previous) */
        bottom: unset;
        left: unset;
        right: 0;
        transform: translateY(-50%);
        border-radius: 16px 0 0 16px;
        min-width: 0;
        width: 90px;
        max-width: 110px;
        flex-direction: column;
        align-items: flex-end;
        box-shadow: -2px 2px 16px rgba(0,0,0,0.22);
      }
      #controlTray.hide {
        right: -110px;
        bottom: unset;
        opacity: 0;
      }
      .tray-btn {
        min-width: 70px;
        font-size: 1em;
        padding: 8px 0;
      }
      #controlTrayBtn {
        right: 0;
        left: unset;
        top: 50%;
        bottom: unset;
        border-radius: 8px 0 0 8px;
        padding: 0 4px;
        font-size: 1.7em;
        width: 32px;
        height: 44px;
      }
    }

  /* STOP OCTAGON BUTTON (main page, now inline with Start) */
  .handpad-action-row {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 5em !important; /* Force more space between START and STOP */
    margin: 0.2em 0 0 0 !important; /* Move row as high as possible, just below handpad */
  }
  .action-btn {
    background: #f5f5f5;
    border: 2.5px solid #28a;
    border-radius: 8px;
    width: 100px;
    height: 100px;
    min-width: 100px;
    min-height: 100px;
    font-size: 2em;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.15s, border 0.15s, box-shadow 0.15s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    position: relative;
    z-index: 2101;
    margin: 0;
    padding: 0;
  }
  .start-action-btn {
    font-weight: bold;
    background: #fff;
    color: #111;
    border: 2.5px solid #28a;
  }
  .start-action-btn:active, .start-action-btn:focus {
    background: #e0eaff;
    color: #111;
    border-color: #1a5a8a;
  }
  body.night-mode .start-action-btn {
    background: #222;
    color: #ff0000;
    border: 2.5px solid #ff0000;
  }
  body.night-mode .start-action-btn:active, body.night-mode .start-action-btn:focus {
    background: #ff0000;
    color: #fff;
    border-color: #ff0000;
  }
  .action-btn:active, .action-btn:focus {
    background: #e0eaff;
    outline: none;
    border-color: #1a5a8a;
  }
  .stop-octagon-btn {
    background: transparent;
    border: 2.5px solid #28a;
    box-shadow: none;
    width: 100px;
    height: 100px;
    min-width: 100px;
    min-height: 100px;
    padding: 0;
    font-size: 2.7em;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    z-index: 2101;
    margin: 0;
  }
  .stop-octagon-btn:active, .stop-octagon-btn:focus {
    background: transparent;
    outline: none;
    border: 2.5px solid #1a5a8a;
  }
  .stop-octagon-svg {
    width: 80px;
    height: 80px;
    display: block;
  }
  .stop-octagon-shape {
    fill: #a11;
    stroke: #28a;
    stroke-width: 2.5 !important;
  }
  .stop-octagon-text {
    font-family: 'Arial Black', Arial, sans-serif;
    font-size: 0.54em;
    font-weight: 900;
    letter-spacing: 0.04em;
    fill: #fff;
    dominant-baseline: middle;
    pointer-events: none;
    user-select: none;
  }
  /* Extra large STOP button variant for main page */
  .stop-octagon-btn--xlarge {
    width: 100px;
    height: 100px;
    min-width: 100px;
    min-height: 100px;
  }
  .stop-octagon-svg--xlarge {
    width: 100px;
    height: 100px;
  }
  .stop-octagon-text--xlarge {
    font-size: 40px;
    letter-spacing: 1.2px;
    font-family: 'Arial Black', Arial, sans-serif;
    font-weight: 900;
    fill: #fff;
    dominant-baseline: middle;
    pointer-events: none;
    user-select: none;
  }
  body.night-mode .stop-octagon-btn {
    background: #222;
    border: 2.5px solid #ff0000;
    box-shadow: 0 2px 8px rgba(255,0,0,0.18);
  }
  body.night-mode .stop-octagon-btn:active, body.night-mode .stop-octagon-btn:focus {
    background: #ff0000;
    border-color: #ff0000;
  }
  body.night-mode .stop-octagon-shape {
    fill: #222;
    stroke: #ff0000;
  }
  body.night-mode .stop-octagon-text {
    fill: #ff0000;
  }
  /* Responsive tweaks for STOP button */
  @media (max-width: 700px) {
    .handpad-action-row {
      gap: 5em !important;
      margin: 1.2em 0 0 0 !important;
    }
    .action-btn {
      width: 80px;
      height: 80px;
      min-width: 80px;
      min-height: 80px;
      font-size: 1.3em;
    }
    .stop-octagon-btn,
    .stop-octagon-btn--xlarge {
      width: 80px;
      height: 80px;
      min-width: 80px;
      min-height: 80px;
    }
    .stop-octagon-svg,
    .stop-octagon-svg--xlarge {
      width: 64px;
      height: 64px;
    }
    .stop-octagon-text--xlarge {
      font-size: 5vw;
      letter-spacing: 1px;
    }
  }
  @media (max-width: 500px) {
    .handpad-action-row {
      gap: 3em !important;
      margin: 1em 0 0 0 !important;
    }
    .action-btn {
      width: 60px;
      height: 60px;
      min-width: 60px;
      min-height: 60px;
      font-size: 1em;
    }
    .stop-octagon-btn,
    .stop-octagon-btn--xlarge {
      width: 60px;
      height: 60px;
      min-width: 60px;
      min-height: 60px;
    }
    .stop-octagon-svg,
    .stop-octagon-svg--xlarge {
      width: 44px;
      height: 44px;
    }
    .stop-octagon-text--xlarge {
      font-size: 7vw;
      letter-spacing: 0.7px;
    }
  }
  /* End STOP octagon button styles */
</style>
<script>
  // Control Tray toggle logic
  $(function(){
    var $tray = $('#controlTray');
    var $btn = $('#controlTrayBtn');
    var $collapse = $('#controlTrayCollapse');
    function setArrow() {
      $btn.html($tray.hasClass('hide') ? '&#x25C0;' : '&#x25B6;');
    }
    $btn.on('click', function(){
      $tray.toggleClass('hide');
      setArrow();
      // If tray is now open, ensure it is visible
      if (!$tray.hasClass('hide')) {
        $tray.show();
      } else {
        $tray.hide();
      }
    });
    $(document).on('click', '#controlTrayCollapse', function(e) {
      $tray.addClass('hide');
      setArrow();
      $tray.hide();
      e.stopPropagation();
    });
    // Removed auto-close tray on outside click: tray now only closes via tray button or collapse button
    // Show tray by default
    $tray.removeClass('hide');
    setArrow();
  });
  </script>
  <script>
    // --- Control Tray visibility logic ---
    function updateTrayVisibility() {
      var mainVisible = document.getElementById('mainViewContainer').style.display !== 'none';
      document.getElementById('controlTrayBtn').style.display = mainVisible ? '' : 'none';
      document.getElementById('controlTray').style.display = mainVisible ? '' : 'none';
    }
    document.addEventListener('DOMContentLoaded', function() {
      updateTrayVisibility();
      // Main to SkyView
      var skyBtn = document.getElementById('skyviewButton');
      if (skyBtn) skyBtn.addEventListener('click', updateTrayVisibility);
      // SkyView to Main
      document.body.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'refreshBtn') updateTrayVisibility();
      });
    });
  </script>
</body>
</html>
